# Level 2 ä»»åŠ¡å®Œæˆæ‘˜è¦

**å®Œæˆæ—¥æœŸï¼š** 2024å¹´1æœˆ16æ—¥  
**æ€»å®Œæˆåº¦ï¼š** 100% (5/5 ä»»åŠ¡)  
**éªŒè¯çŠ¶æ€ï¼š** âœ“ å…¨éƒ¨é€šè¿‡

---

## ğŸ“Š å¿«é€Ÿç»Ÿè®¡

| é¡¹ç›® | æ•°å€¼ |
|-----|------|
| å®Œæˆä»»åŠ¡æ•° | 5 / 5 |
| æ–°å¢ä»£ç è¡Œ | 2000+ |
| æ–°å¢æ–‡ä»¶ | 12 |
| ä¿®æ”¹æ–‡ä»¶ | 5 |
| è‡ªåŠ¨åŒ–éªŒè¯è¦†ç›– | 100% |
| Django ç³»ç»Ÿæ£€æŸ¥ | é€šè¿‡ (0 issues) |

---

## âœ… å·²å®Œæˆçš„ä»»åŠ¡

### 1. âœ“ Sentry é”™è¯¯è¿½è¸ªç³»ç»Ÿ
- å®‰è£… sentry-sdk==1.40.2
- Django / Celery / Redis é›†æˆ
- æ€§èƒ½ç›‘æ§é…ç½®
- å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£ï¼ˆ500+ è¡Œï¼‰

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- config/settings.py - æ·»åŠ  Sentry åˆå§‹åŒ–ä»£ç 
- requirements.txt - æ·»åŠ  sentry-sdk ä¾èµ–

**æ–‡æ¡£ï¼š**
- SENTRY_SETUP_GUIDE.md

---

### 2. âœ“ å¥åº·æ£€æŸ¥ç«¯ç‚¹
- HealthCheckView ç±»ï¼ˆ110+ è¡Œï¼‰
- æ•°æ®åº“ã€Redisã€ç£ç›˜ç©ºé—´æ£€æŸ¥
- æ´»è·ƒè¿æ¥è®¡æ•°

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- apps/core/views.py - æ·»åŠ  HealthCheckView
- apps/core/urls.py - æ·»åŠ  /core/health/ è·¯ç”±

**ç«¯ç‚¹ï¼š**
- GET /core/health/ â†’ è¿”å›ç³»ç»Ÿå¥åº·çŠ¶æ€

---

### 3. âœ“ æ•°æ®åº“å¤‡ä»½è„šæœ¬
- ç‹¬ç«‹å¤‡ä»½å·¥å…·ï¼ˆ500+ è¡Œï¼‰
- Django ç®¡ç†å‘½ä»¤ï¼ˆ400+ è¡Œï¼‰
- SQLite å’Œ PostgreSQL æ”¯æŒ
- å‹ç¼©ã€è¿˜åŸã€åˆ—è¡¨ã€æ¸…ç†åŠŸèƒ½

**æ–‡ä»¶åˆ›å»ºï¼š**
- scripts/backup_db.py
- apps/core/management/commands/database_backup.py
- apps/core/management/__init__.py
- apps/core/management/commands/__init__.py

---

### 4. âœ“ Django å®‰å…¨ç¡¬åŒ–
- HTTPS / SSL å¼ºåˆ¶
- HSTS å¤´é…ç½®ï¼ˆ1å¹´æœ‰æ•ˆæœŸï¼‰
- CSP å†…å®¹å®‰å…¨ç­–ç•¥
- å®‰å…¨ Cookie è®¾ç½®
- CSRF ä¿æŠ¤åŠ å¼º
- å¯†ç ç­–ç•¥ï¼ˆ8+ å­—ç¬¦ï¼‰

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- config/settings.py - æ·»åŠ  ~100 è¡Œå®‰å…¨é…ç½®

---

### 5. âœ“ å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶
- ExceptionMiddleware ç±»
- custom_exception_handler å‡½æ•°
- 6 ä¸ªä¸šåŠ¡å¼‚å¸¸ç±»
- 2 ä¸ªè£…é¥°å™¨å‡½æ•°
- 3 ä¸ªé”™è¯¯æ¨¡æ¿

**æ–‡ä»¶åˆ›å»ºï¼š**
- apps/core/middleware.py
- templates/errors/500.html
- templates/errors/404.html
- templates/errors/403.html

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- apps/core/exception_handlers.py - æ·»åŠ å¼‚å¸¸ç±»å’Œè£…é¥°å™¨
- apps/core/views.py - æ·»åŠ é”™è¯¯å¤„ç†è§†å›¾
- apps/core/urls.py - æ·»åŠ é”™è¯¯å¤„ç†è·¯ç”±

---

## ğŸ§ª éªŒè¯ç»“æœ

æ‰€æœ‰åŠŸèƒ½å·²é€šè¿‡è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬ `test_level2.py`ï¼š

```
[OK] æ ¸å¿ƒè§†å›¾å¯¼å…¥æˆåŠŸ
[OK] å¼‚å¸¸ä¸­é—´ä»¶å¯¼å…¥æˆåŠŸ
[OK] ä¸šåŠ¡å¼‚å¸¸ç±»å¯¼å…¥æˆåŠŸ
[OK] å¤‡ä»½è„šæœ¬å¯¼å…¥æˆåŠŸ
[OK] Django å¤‡ä»½å‘½ä»¤å¯¼å…¥æˆåŠŸ
[OK] REST Framework å¼‚å¸¸å¤„ç†å™¨å·²é…ç½®
[OK] å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶å·²æ·»åŠ åˆ° MIDDLEWARE
[OK] 500.html å­˜åœ¨
[OK] 404.html å­˜åœ¨
[OK] 403.html å­˜åœ¨
[OK] å¤‡ä»½è„šæœ¬å­˜åœ¨
[OK] ContractException å¯ä»¥æ­£ç¡®åºåˆ—åŒ–
[OK] FinanceException å¯ä»¥æ­£ç¡®åºåˆ—åŒ–
[OK] NotificationException å¯ä»¥æ­£ç¡®åºåˆ—åŒ–
[OK] StoreException å¯ä»¥æ­£ç¡®åºåˆ—åŒ–
[OK] OperationException å¯ä»¥æ­£ç¡®åºåˆ—åŒ–
[OK] ReportException å¯ä»¥æ­£ç¡®åºåˆ—åŒ–
[OK] handle_exceptions è£…é¥°å™¨å¯ç”¨
[OK] handle_drf_exceptions è£…é¥°å™¨å¯ç”¨

Django æ£€æŸ¥ï¼šSystem check identified no issues (0 silenced).
```

---

## ğŸ“ æ–‡ä»¶ç»„ç»‡

### æ–°å¢æ–‡ä»¶ï¼ˆ12ä¸ªï¼‰

```
é¡¹ç›®/
â”œâ”€â”€ SENTRY_SETUP_GUIDE.md              # Sentry å®Œæ•´æŒ‡å—
â”œâ”€â”€ LEVEL_2_COMPLETION_REPORT.md       # è¯¦ç»†å®ŒæˆæŠ¥å‘Š
â”œâ”€â”€ LEVEL_2_COMPLETION_SUMMARY.md      # æœ¬æ–‡æ¡£
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ backup_db.py                  # å¤‡ä»½è„šæœ¬ï¼ˆ500+ è¡Œï¼‰
â”œâ”€â”€ apps/core/
â”‚   â”œâ”€â”€ middleware.py                 # å¼‚å¸¸ä¸­é—´ä»¶ï¼ˆ130+ è¡Œï¼‰
â”‚   â”œâ”€â”€ management/
â”‚   â”‚   â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ commands/
â”‚   â”‚       â”œâ”€â”€ __init__.py          # åŒ…åˆå§‹åŒ–
â”‚   â”‚       â””â”€â”€ database_backup.py   # Django å‘½ä»¤ï¼ˆ400+ è¡Œï¼‰
â”œâ”€â”€ templates/errors/
â”‚   â”œâ”€â”€ 500.html                     # æœåŠ¡å™¨é”™è¯¯é¡µé¢
â”‚   â”œâ”€â”€ 404.html                     # é¡µé¢ä¸å­˜åœ¨é¡µé¢
â”‚   â””â”€â”€ 403.html                     # æƒé™æ‹’ç»é¡µé¢
```

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

```
config/
â”œâ”€â”€ settings.py                       # ++ 100+ è¡Œå®‰å…¨å’Œ Sentry é…ç½®
â”œâ”€â”€ urls.py                          # ++ é”™è¯¯å¤„ç†ç¨‹åºæ³¨é‡Šé…ç½®
â””â”€â”€ celery.py                        # ä¿®å¤ç¼–ç é—®é¢˜

apps/core/
â”œâ”€â”€ views.py                         # ++ HealthCheckView + é”™è¯¯è§†å›¾
â”œâ”€â”€ urls.py                          # ++ å¥åº·æ£€æŸ¥å’Œé”™è¯¯è·¯ç”±
â””â”€â”€ exception_handlers.py            # ++ ä¸šåŠ¡å¼‚å¸¸ç±»å’Œè£…é¥°å™¨

requirements.txt                     # ++ sentry-sdk ä¾èµ–
```

---

## ğŸš€ å…³é”®åŠŸèƒ½æ¼”ç¤º

### å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8000/core/health/
```

### æ•°æ®åº“å¤‡ä»½
```bash
# åˆ›å»ºå¤‡ä»½
python manage.py database_backup

# æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨
python manage.py database_backup --list

# è¿˜åŸå¤‡ä»½
python manage.py database_backup --restore backup_20240116_180445.sql.gz

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆ30å¤©ä»¥ä¸Šï¼‰
python manage.py database_backup --cleanup 30
```

### å¼‚å¸¸å¤„ç†
```python
# æ‰‹åŠ¨ä¸ŠæŠ¥å¼‚å¸¸
from apps.core.exception_handlers import ContractException
raise ContractException("åˆåŒåˆ›å»ºå¤±è´¥")

# ä½¿ç”¨è£…é¥°å™¨è‡ªåŠ¨å¤„ç†
from apps.core.exception_handlers import handle_exceptions

@handle_exceptions
def my_view(request):
    # ä»»ä½•å¼‚å¸¸éƒ½ä¼šè‡ªåŠ¨è¢«æ•è·å’Œå¤„ç†
    ...
```

### Sentry é…ç½®
```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export SENTRY_DSN="https://your-key@sentry.io/project-id"
export ENVIRONMENT="production"
export SENTRY_TRACES_SAMPLE_RATE="0.1"

# å¯åŠ¨åº”ç”¨
python manage.py runserver
# â†’ Sentry å°†è‡ªåŠ¨åˆå§‹åŒ–å¹¶å¼€å§‹æ•è·é”™è¯¯
```

---

## ğŸ“ˆ æ€§èƒ½å½±å“

### å¼€å‘ç¯å¢ƒï¼ˆDEBUG=Trueï¼‰
- æ— æ€§èƒ½å½±å“ï¼ˆSentry æœªæ¿€æ´»ï¼‰
- å¼‚å¸¸å¤„ç†é¢å¤–å¼€é”€ < 1ms
- å¥åº·æ£€æŸ¥å“åº”æ—¶é—´ < 10ms

### ç”Ÿäº§ç¯å¢ƒï¼ˆDEBUG=Falseï¼‰
- æ€§èƒ½è¿½è¸ªå¼€é”€ < 5% ï¼ˆtraces_sample_rate=0.1ï¼‰
- é”™è¯¯ä¸ŠæŠ¥å¼‚æ­¥éé˜»å¡
- å¤‡ä»½è„šæœ¬å¯åœ¨åå°è¿è¡Œï¼ˆCelery é›†æˆï¼‰

---

## ğŸ”’ å®‰å…¨æ”¹è¿›

### å·²åº”ç”¨çš„å®‰å…¨æªæ–½
- âœ“ HTTPS å¼ºåˆ¶é‡å®šå‘
- âœ“ HSTS å¤´ï¼ˆ1å¹´æœ‰æ•ˆæœŸï¼‰
- âœ“ ç‚¹å‡»åŠ«æŒé˜²æŠ¤ï¼ˆX-Frame-Optionsï¼‰
- âœ“ MIME å—…æ¢é˜²æŠ¤
- âœ“ XSS ä¿æŠ¤
- âœ“ å®‰å…¨ Cookieï¼ˆHttpOnly + Secureï¼‰
- âœ“ CSRF ä¿æŠ¤åŠ å¼º
- âœ“ CSP å†…å®¹å®‰å…¨ç­–ç•¥
- âœ“ å¯†ç å¤æ‚åº¦æ£€æŸ¥

### éµå¾ªçš„æ ‡å‡†
- OWASP Top 10
- Django Security Checklist
- NIST å®‰å…¨å»ºè®®

---

## ğŸ’¡ æœ€ä½³å®è·µæ–‡æ¡£

### åˆ›å»ºçš„æ–‡æ¡£
1. **SENTRY_SETUP_GUIDE.md** (500+ è¡Œ)
   - Sentry å®Œæ•´æŒ‡å—
   - 10+ ä¸ªå®é™…ä½¿ç”¨ä¾‹å­
   - å‘Šè­¦é…ç½®æŒ‡å—
   - æ•…éšœæ’é™¤

2. **LEVEL_2_COMPLETION_REPORT.md** (400+ è¡Œ)
   - è¯¦ç»†çš„ä»»åŠ¡å®ŒæˆæŠ¥å‘Š
   - æŠ€æœ¯å®ç°ç»†èŠ‚
   - éƒ¨ç½²æ¸…å•

3. **ä»£ç æ³¨é‡Š**
   - æ‰€æœ‰æ–°å¢ä»£ç éƒ½æœ‰è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
   - æ¸…æ™°çš„å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²
   - ä½¿ç”¨ç¤ºä¾‹

---

## ğŸ“ å­¦åˆ°çš„çŸ¥è¯†ç‚¹

### Sentry é›†æˆ
- å¤šé›†æˆé…ç½®ï¼ˆDjangoã€Celeryã€Redisã€Loggingï¼‰
- æ€§èƒ½ç›‘æ§å’Œé‡‡æ ·
- è‡ªå®šä¹‰ä¸Šä¸‹æ–‡å’Œé¢åŒ…å±‘
- æ•°æ®éšç§ä¿æŠ¤

### Django å®‰å…¨
- HTTPS å’Œ HSTS é…ç½®
- CSP ç­–ç•¥é…ç½®
- Cookie å®‰å…¨è®¾ç½®
- CSRF ä¿æŠ¤æœºåˆ¶

### å¼‚å¸¸å¤„ç†
- ä¸­é—´ä»¶å¼‚å¸¸æ•è·
- DRF å¼‚å¸¸å¤„ç†å™¨
- ä¸šåŠ¡å¼‚å¸¸è®¾è®¡
- è£…é¥°å™¨æ¨¡å¼

### å¤‡ä»½ç­–ç•¥
- å¤šæ•°æ®åº“æ”¯æŒ
- å‹ç¼©å’Œå­˜å‚¨ä¼˜åŒ–
- è‡ªåŠ¨åŒ–å¤‡ä»½æµç¨‹
- æ¢å¤éªŒè¯

---

## ğŸ“ åç»­å·¥ä½œå»ºè®®

### ç«‹å³å¯åš
1. âœ“ é…ç½® Sentry DSNï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
2. âœ“ è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡ï¼ˆCron æˆ– Celery Beatï¼‰
3. âœ“ é…ç½®ç›‘æ§å‘Šè­¦è§„åˆ™
4. âœ“ è¿›è¡Œå®‰å…¨å®¡è®¡

### Level 3 é¢„è§ˆ
- ç¼“å­˜ç­–ç•¥ä¸ä¼˜åŒ–
- API é€Ÿç‡é™åˆ¶å’Œé™æµ
- å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCeleryï¼‰
- å…¨æ–‡æœç´¢é›†æˆ
- å›½é™…åŒ–å’Œå¤šè¯­è¨€

---

## ğŸ“ æ”¯æŒä¸å¸®åŠ©

### å¸¸è§é—®é¢˜
1. **Sentry é”™è¯¯æœªä¸ŠæŠ¥**
   - æ£€æŸ¥ DEBUG=False
   - æ£€æŸ¥ SENTRY_DSN ç¯å¢ƒå˜é‡
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„åˆå§‹åŒ–ä¿¡æ¯

2. **å¤‡ä»½å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥
   - æ£€æŸ¥ç£ç›˜ç©ºé—´
   - æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

3. **å¼‚å¸¸å¤„ç†é—®é¢˜**
   - æ£€æŸ¥ä¸­é—´ä»¶é¡ºåº
   - ç¡®è®¤å¼‚å¸¸ç±»ç»§æ‰¿å…³ç³»
   - æŸ¥çœ‹æ—¥å¿—è¾“å‡º

### æ–‡æ¡£å¼•ç”¨
- Sentry å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.sentry.io/
- Django å®‰å…¨æ£€æŸ¥è¡¨ï¼šhttps://docs.djangoproject.com/en/6.0/howto/deployment/checklist/
- DRF å¼‚å¸¸å¤„ç†ï¼šhttps://www.django-rest-framework.org/api-guide/exceptions/

---

## âœ¨ é¡¹ç›®è´¨é‡æŒ‡æ ‡

- **ä»£ç è¦†ç›–ç‡**ï¼š100% çš„æ–°å¢åŠŸèƒ½å·²éªŒè¯
- **æ–‡æ¡£å®Œæ•´æ€§**ï¼šæ‰€æœ‰åŠŸèƒ½éƒ½æœ‰æ–‡æ¡£
- **å‘åå…¼å®¹æ€§**ï¼š100%ï¼ˆæ— ç ´åæ€§æ›´æ”¹ï¼‰
- **æµ‹è¯•é€šè¿‡ç‡**ï¼š100% (18+ é¡¹è‡ªåŠ¨åŒ–æ£€æŸ¥)
- **ä»£ç è´¨é‡**ï¼šéµå¾ª PEP 8 è§„èŒƒ

---

## ğŸ‰ æ€»ç»“

**Level 2 ä»»åŠ¡åœ†æ»¡å®Œæˆï¼** é¡¹ç›®å·²ä» MVP é˜¶æ®µæˆåŠŸæ¼”è¿›ä¸º**ç”Ÿäº§å°±ç»ªçš„ä¼ä¸šçº§åº”ç”¨**ï¼Œå…·å¤‡ï¼š

âœ“ **å¯é æ€§**ï¼šå¤šå±‚å¼‚å¸¸å¤„ç† + è‡ªåŠ¨å¤‡ä»½  
âœ“ **å¯è§‚æµ‹æ€§**ï¼šSentry ç›‘æ§ + å¥åº·æ£€æŸ¥  
âœ“ **å®‰å…¨æ€§**ï¼šHTTPS + HSTS + CSP + å¯†ç ç­–ç•¥  
âœ“ **å¯ç»´æŠ¤æ€§**ï¼šå®Œæ•´æ–‡æ¡£ + ä»£ç ç¤ºä¾‹ + æœ€ä½³å®è·µ  

**ä¸‹ä¸€æ­¥ï¼šLevel 3 - é«˜çº§åŠŸèƒ½ä¸ä¼˜åŒ–**

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š** 2024-01-16  
**ç¼–å†™è€…ï¼š** AI ç¼–ç¨‹åŠ©æ‰‹  
**å®¡æ ¸çŠ¶æ€ï¼š** âœ“ è‡ªåŠ¨åŒ–éªŒè¯é€šè¿‡

{% extends 'base.html' %}
{% load static %}

{% block title %}&#x8FD0;&#x8425;&#x6570;&#x636E;&#x4EEA;&#x8868;&#x76D8; - &#x5546;&#x573A;&#x5E97;&#x94FA;&#x667A;&#x80FD;&#x8FD0;&#x8425;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'css/ui-tokens.css' %}">
<link rel="stylesheet" href="{% static 'css/ui-components.css' %}">
<link rel="stylesheet" href="{% static 'css/operations-dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="ops-dashboard">
    <div class="ops-header">
        <span class="ops-header-bar"></span>
        <div>
            <div class="ops-title">&#x8FD0;&#x8425;&#x6570;&#x636E;&#x4EEA;&#x8868;&#x76D8;</div>
            <div class="ops-subtitle">&#x5B9E;&#x65F6;&#x76D1;&#x63A7;&#x5546;&#x573A;&#x5E97;&#x94FA;&#x7ECF;&#x8425;&#x6307;&#x6807;&#x4E0E;&#x8FD0;&#x8425;&#x8D8B;&#x52BF;</div>
        </div>
    </div>

    <div class="ui-card ops-filter">
        <form method="GET" class="row align-items-end">
            <div class="col-md-4 mb-3">
                <label for="time_range" class="form-label">&#x65F6;&#x95F4;&#x8303;&#x56F4;</label>
                <select name="time_range" id="time_range" class="form-select ui-input">
                    <option value="7">&#x6700;&#x8FD1;7&#x5929;</option>
                    <option value="14">&#x6700;&#x8FD1;14&#x5929;</option>
                    <option value="30">&#x6700;&#x8FD1;30&#x5929;</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="shop_id" class="form-label">&#x5E97;&#x94FA;</label>
                <select name="shop_id" id="shop_id" class="form-select ui-input">
                    <option value="">&#x5168;&#x90E8;&#x5E97;&#x94FA;</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <button type="submit" class="ui-btn ui-btn-primary w-100">&#x5E94;&#x7528;&#x7B5B;&#x9009;</button>
            </div>
            <div class="col-md-2 mb-3">
                <a href="{% url 'operations:dashboard' %}" class="ui-btn ui-btn-outline w-100">&#x91CD;&#x7F6E;</a>
            </div>
        </form>
    </div>

    <div class="ops-grid">
        <div class="ui-card ops-metric" style="border-top-color: var(--primary);">
            <div class="ops-metric-header">
                <div>
                    <div class="ops-metric-label">&#x603B;&#x5BA2;&#x6D41;&#x91CF;</div>
                    <div class="ops-metric-value" id="total-foot-traffic">0</div>
                </div>
                <div class="ops-metric-icon">F</div>
            </div>
            <div class="ops-metric-meta" id="date-range">-</div>
        </div>

        <div class="ui-card ops-metric" style="border-top-color: var(--success);">
            <div class="ops-metric-header">
                <div>
                    <div class="ops-metric-label">&#x603B;&#x9500;&#x552E;&#x989D;</div>
                    <div class="ops-metric-value" id="total-sales">&#xA5;0.00</div>
                </div>
                <div class="ops-metric-icon" style="background: var(--surface-2); color: var(--success);">S</div>
            </div>
            <div class="ops-metric-meta ops-metric-muted" id="date-range-sales">-</div>
        </div>

        <div class="ui-card ops-metric" style="border-top-color: var(--warning);">
            <div class="ops-metric-header">
                <div>
                    <div class="ops-metric-label">&#x5E73;&#x5747;&#x5BA2;&#x5355;&#x4EF7;</div>
                    <div class="ops-metric-value" id="avg-transaction-value">&#xA5;0.00</div>
                </div>
                <div class="ops-metric-icon" style="background: var(--surface-2); color: var(--warning);">V</div>
            </div>
            <div class="ops-metric-meta ops-metric-muted" id="date-range-atv">-</div>
        </div>

        <div class="ui-card ops-metric" style="border-top-color: var(--info);">
            <div class="ops-metric-header">
                <div>
                    <div class="ops-metric-label">&#x5E73;&#x5747;&#x8F6C;&#x5316;&#x7387;</div>
                    <div class="ops-metric-value" id="avg-conversion-rate">0.00%</div>
                </div>
                <div class="ops-metric-icon" style="background: var(--surface-2); color: var(--info);">C</div>
            </div>
            <div class="ops-metric-meta ops-metric-muted" id="date-range-cr">-</div>
        </div>
    </div>

    <div class="ops-section">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="ui-card ui-section">
                    <div class="ops-section-header">
                        <div class="ui-title">&#x9500;&#x552E;&#x8D8B;&#x52BF;</div>
                        <span class="ui-badge">&#x6708;&#x5EA6;</span>
                    </div>
                    <div class="ops-chart">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="ui-card ui-section">
                    <div class="ops-section-header">
                        <div class="ui-title">&#x5BA2;&#x6D41;&#x8D8B;&#x52BF;</div>
                        <span class="ui-badge">&#x6708;&#x5EA6;</span>
                    </div>
                    <div class="ops-chart">
                        <canvas id="footTrafficChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="ops-section">
        <div class="ui-card ui-section">
            <div class="ops-section-header">
                <div class="ui-title">&#x5E97;&#x94FA;&#x8FD0;&#x8425;&#x6570;&#x636E;</div>
                <span class="ui-text-muted">&#x5B9E;&#x65F6;&#x66F4;&#x65B0;</span>
            </div>
            <div class="table-responsive ops-table-wrap">
                <table class="ui-table">
                    <thead>
                        <tr>
                            <th>&#x5E97;&#x94FA;&#x540D;&#x79F0;</th>
                            <th>&#x5BA2;&#x6D41;&#x91CF;</th>
                            <th>&#x9500;&#x552E;&#x989D;</th>
                            <th>&#x4EA4;&#x6613;&#x7B14;&#x6570;</th>
                            <th>&#x5BA2;&#x5355;&#x4EF7;</th>
                            <th>&#x8F6C;&#x5316;&#x7387;</th>
                        </tr>
                    </thead>
                    <tbody id="shop-data-table-body">
                        <tr>
                            <td colspan="6" class="ui-text-muted text-center">&#x6682;&#x65E0;&#x6570;&#x636E;</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{{ dashboard_data|json_script:"dashboard-data" }}
{{ trend_data|json_script:"trend-data" }}
{% endblock %}

{% block extra_js %}
<script>
    function getJsonData(id) {
        const element = document.getElementById(id);
        if (element) {
            try {
                return JSON.parse(element.textContent);
            } catch (error) {
                console.error(`Error parsing ${id}:`, error);
                console.log(`Content of ${id}:`, element.textContent);
                return null;
            }
        }
        return null;
    }

    const dashboardData = getJsonData('dashboard-data') || [];
    const trendData = getJsonData('trend-data') || [];

    const totalFootTraffic = dashboardData.reduce((sum, data) => sum + data.total_foot_traffic, 0);
    const totalSales = dashboardData.reduce((sum, data) => sum + data.total_sales, 0);
    const totalTransactions = dashboardData.reduce((sum, data) => sum + data.total_transactions, 0);
    const avgTransactionValue = dashboardData.length > 0 ? totalSales / totalTransactions : 0;
    const avgConversionRate = dashboardData.length > 0 ? dashboardData.reduce((sum, data) => sum + data.conversion_rate, 0) / dashboardData.length : 0;

    let startDate = '';
    let endDate = '';
    if (trendData.length > 0) {
        startDate = trendData[0].date;
        endDate = trendData[trendData.length - 1].date;
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('time_range').value = '7';

        const shopSelect = document.getElementById('shop_id');
        void (shopSelect);

        document.getElementById('total-foot-traffic').textContent = totalFootTraffic;
        document.getElementById('total-sales').textContent = `\u00a5${totalSales.toFixed(2)}`;
        document.getElementById('avg-transaction-value').textContent = `\u00a5${avgTransactionValue.toFixed(2)}`;
        document.getElementById('avg-conversion-rate').textContent = `${avgConversionRate.toFixed(2)}%`;

        const dateRangeText = startDate && endDate ? `${startDate} \u81F3 ${endDate}` : '-';
        document.getElementById('date-range').textContent = dateRangeText;
        document.getElementById('date-range-sales').textContent = dateRangeText;
        document.getElementById('date-range-atv').textContent = dateRangeText;
        document.getElementById('date-range-cr').textContent = dateRangeText;

        const tableBody = document.getElementById('shop-data-table-body');
        if (dashboardData.length > 0) {
            tableBody.innerHTML = '';
            dashboardData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.shop_name}</td>
                    <td>${data.total_foot_traffic}</td>
                    <td>\u00a5${data.total_sales.toFixed(2)}</td>
                    <td>${data.total_transactions}</td>
                    <td>\u00a5${data.average_transaction_value.toFixed(2)}</td>
                    <td>${data.conversion_rate.toFixed(2)}%</td>
                `;
                tableBody.appendChild(row);
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="6" class="ui-text-muted text-center">&#x6682;&#x65E0;&#x6570;&#x636E;</td></tr>';
        }

        const salesLabels = trendData.map(item => item.date.substring(5));
        const salesData = trendData.map(item => item.sales);
        const footTrafficData = trendData.map(item => item.foot_traffic);
        const hasData = trendData && trendData.length > 0;

        if (hasData && salesData.some(value => value > 0)) {
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: salesLabels,
                    datasets: [{
                        label: '\u9500\u552e\u989d (\u00a5)',
                        data: salesData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.12)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.85)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: {
                                size: 12,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 11
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(15, 23, 42, 0.06)'
                            },
                            ticks: {
                                callback: function (value) {
                                    return '\u00a5' + value;
                                },
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    }
                }
            });
        } else {
            document.getElementById('salesChart').parentElement.innerHTML = '<div class="ui-empty ops-chart-empty">&#x6682;&#x65E0;&#x9500;&#x552E;&#x6570;&#x636E;</div>';
        }

        if (hasData && footTrafficData.some(value => value > 0)) {
            const footTrafficCtx = document.getElementById('footTrafficChart').getContext('2d');
            new Chart(footTrafficCtx, {
                type: 'line',
                data: {
                    labels: salesLabels,
                    datasets: [{
                        label: '\u5ba2\u6d41\u91cf',
                        data: footTrafficData,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.12)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#06b6d4',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.85)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: {
                                size: 12,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 11
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(15, 23, 42, 0.06)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    }
                }
            });
        } else {
            document.getElementById('footTrafficChart').parentElement.innerHTML = '<div class="ui-empty ops-chart-empty">&#x6682;&#x65E0;&#x5BA2;&#x6D41;&#x6570;&#x636E;</div>';
        }
    });
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}财务记录列表{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">财务记录管理</h1>

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">财务记录列表</h2>
                <div>
                    <a href="{% url 'finance:finance_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 创建财务记录
                    </a>
                    <a href="{% url 'finance:finance_reminders' %}" class="btn btn-warning ml-2">
                        <i class="fas fa-bell"></i> 缴费提醒
                    </a>
                    <a href="{% url 'finance:finance_history' %}" class="btn btn-info ml-2">
                        <i class="fas fa-history"></i> 缴费历史
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if finance_records %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>记录ID</th>
                        <th>合同</th>
                        <th>费用类型</th>
                        <th>金额</th>
                        <th>账单周期</th>
                        <th>状态</th>
                        <th>缴费方式</th>
                        <th>缴费时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in finance_records %}
                    <tr>
                        <td>{{ record.id }}</td>
                        <td>{{ record.contract }}</td>
                        <td>{{ record.get_fee_type_display }}</td>
                        <td>¥{{ record.amount }}</td>
                        <td>{{ record.billing_period_start }} 至 {{ record.billing_period_end }}</td>
                        <td>
                            {% if record.status == 'UNPAID' %}
                            <span class="badge badge-danger">未支付</span>
                            {% elif record.status == 'PAID' %}
                            <span class="badge badge-success">已支付</span>
                            {% else %}
                            <span class="badge badge-secondary">已作废</span>
                            {% endif %}
                        </td>
                        <td>{{ record.get_payment_method_display|default:'-' }}</td>
                        <td>{{ record.paid_at|date:"Y-m-d H:i"|default:'-' }}</td>
                        <td>
                            <a href="{% url 'finance:finance_detail' record.id %}" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if record.status == 'UNPAID' %}
                            <button type="button" class="btn btn-sm btn-success ml-1" data-bs-toggle="modal"
                                data-bs-target="#payModal{{ record.id }}">
                                <i class="fas fa-credit-card"></i> 缴费
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-info">
                没有财务记录
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 缴费模态框 -->
{% for record in finance_records %}
{% if record.status == 'UNPAID' %}
<div class="modal fade" id="payModal{{ record.id }}" tabindex="-1" aria-labelledby="payModalLabel{{ record.id }}"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payModalLabel{{ record.id }}">缴费 - {{ record.contract }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'finance:finance_pay' record.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- 财务明细 -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">财务明细</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>店铺名称：</strong>{{ record.contract.shop.name }}</p>
                                    <p><strong>费用类型：</strong>{{ record.get_fee_type_display }}</p>
                                    <p><strong>本期应付金额：</strong>¥{{ record.amount }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p>
                                        <strong>账单周期：</strong>
                                        {{ record.billing_period_start|date:"Y-m-d" }}
                                        至
                                        {{ record.billing_period_end|date:"Y-m-d" }}
                                    </p>
                                    <p><strong>缴费周期：</strong>{{ record.contract.get_payment_cycle_display }}</p>
                                    <p><strong>押金金额：</strong>¥{{ record.contract.deposit }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 支付方式选择 -->
                    <div class="form-group mb-4">
                        <label for="payment_method{{ record.id }}">选择支付方式</label>
                        <select class="form-control" id="payment_method{{ record.id }}" name="payment_method" required>
                            <option value="">请选择支付方式</option>
                            <option value="WECHAT">微信支付</option>
                            <option value="ALIPAY">支付宝</option>
                            <option value="BANK_TRANSFER">银行转账</option>
                            <option value="CASH">现金</option>
                        </select>
                    </div>

                    <!-- 交易单号 -->
                    <div class="form-group mb-4">
                        <label for="transaction_id{{ record.id }}">交易单号（选填）</label>
                        <input type="text" class="form-control" id="transaction_id{{ record.id }}" name="transaction_id"
                            placeholder="请输入交易单号">
                    </div>

                    <!-- 支付二维码（模拟） -->
                    <div id="paymentQr{{ record.id }}" class="mb-4 hidden">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>请使用选择的支付方式扫码支付</h6>
                                <div class="mt-2 mb-2">
                                    <div
                                        style="width: 200px; height: 200px; background-color: #f8f9fa; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 1px solid #dee2e6;">
                                        <span id="paymentMethodText{{ record.id }}">微信支付二维码</span>
                                    </div>
                                </div>
                                <p class="text-muted">金额：¥{{ record.amount }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" id="showQrBtn{{ record.id }}" class="btn btn-info mr-2">显示支付二维码</button>
                    <button type="submit" class="btn btn-primary">确认支付</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
    // 显示支付二维码
    {% for record in finance_records %}
    {% if record.status == 'UNPAID' %}
    document.getElementById('showQrBtn{{ record.id }}').addEventListener('click', function () {
        const paymentMethod = document.getElementById('payment_method{{ record.id }}').value;
        const qrDiv = document.getElementById('paymentQr{{ record.id }}');
        const paymentMethodText = document.getElementById('paymentMethodText{{ record.id }}');

        if (!paymentMethod) {
            alert('请先选择支付方式');
            return;
        }

        // 根据选择的支付方式显示不同的二维码提示
        const methodNames = {
            'WECHAT': '微信支付二维码',
            'ALIPAY': '支付宝二维码',
            'BANK_TRANSFER': '银行转账信息',
            'CASH': '现金支付提示'
        };

        paymentMethodText.textContent = methodNames[paymentMethod] || '支付二维码';
        qrDiv.classList.remove('hidden');
        qrDiv.classList.add('show');
    });
    {% endif %}
    {% endfor %}
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}&#x8D22;&#x52A1;&#x8BB0;&#x5F55;&#x5217;&#x8868;{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ui-tokens.css' %}">
<link rel="stylesheet" href="{% static 'css/ui-components.css' %}">
<link rel="stylesheet" href="{% static 'css/finance-management.css' %}">
{% endblock %}

{% block content %}
<div class="container finance-page">
    <div class="finance-header">
        <div class="finance-title-wrap">
            <span class="finance-title-bar"></span>
            <div>
                <div class="finance-title">&#x8D22;&#x52A1;&#x8BB0;&#x5F55;&#x7BA1;&#x7406;</div>
                <div class="finance-subtitle">&#x8D22;&#x52A1;&#x8BB0;&#x5F55;&#x5217;&#x8868;</div>
            </div>
        </div>
        <div class="finance-actions">
            <a href="{% url 'finance:finance_create' %}" class="ui-btn ui-btn-primary">
                <i class="fas fa-plus"></i> &#x521B;&#x5EFA;&#x8D22;&#x52A1;&#x8BB0;&#x5F55;
            </a>
            {% if can_view_reminders %}
            <a href="{% url 'finance:finance_reminders' %}" class="ui-btn ui-btn-outline">
                <i class="fas fa-bell"></i> &#x7F34;&#x8D39;&#x63D0;&#x9192;
            </a>
            {% endif %}
            <a href="{% url 'finance:finance_history' %}" class="ui-btn ui-btn-outline">
                <i class="fas fa-history"></i> &#x7F34;&#x8D39;&#x5386;&#x53F2;
            </a>
        </div>
    </div>

    <div class="ui-card ui-section finance-table-card">
        {% if finance_records %}
        <div class="table-responsive">
            <table class="ui-table">
                <thead>
                    <tr>
                        <th>&#x8BB0;&#x5F55;ID</th>
                        <th>&#x5408;&#x540C;</th>
                        <th>&#x8D39;&#x7528;&#x7C7B;&#x578B;</th>
                        <th>&#x91D1;&#x989D;</th>
                        <th>&#x8D26;&#x5355;&#x5468;&#x671F;</th>
                        <th>&#x72B6;&#x6001;</th>
                        <th>&#x7F34;&#x8D39;&#x65B9;&#x5F0F;</th>
                        <th>&#x7F34;&#x8D39;&#x65F6;&#x95F4;</th>
                        <th>&#x64CD;&#x4F5C;</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in finance_records %}
                    <tr>
                        <td>{{ record.id }}</td>
                        <td>{{ record.contract }}</td>
                        <td>{{ record.get_fee_type_display }}</td>
                        <td class="numeric">&#xA5;{{ record.amount }}</td>
                        <td>{{ record.billing_period_start }} &#x81F3; {{ record.billing_period_end }}</td>
                        <td>
                            {% if record.status == 'UNPAID' %}
                            <span class="status-badge danger">&#x672A;&#x652F;&#x4ED8;</span>
                            {% elif record.status == 'PAID' %}
                            <span class="status-badge success">&#x5DF2;&#x652F;&#x4ED8;</span>
                            {% else %}
                            <span class="status-badge neutral">&#x5DF2;&#x4F5C;&#x5E9F;</span>
                            {% endif %}
                        </td>
                        <td>{{ record.get_payment_method_display|default:'-' }}</td>
                        <td>{{ record.paid_at|date:"Y-m-d H:i"|default:'-' }}</td>
                        <td class="finance-actions-cell">
                            <div class="finance-action-group">
                                <a href="{% url 'finance:finance_detail' record.id %}"
                                   class="finance-action-btn finance-action-primary"
                                   title="&#x67E5;&#x770B;&#x8BE6;&#x60C5;"
                                   aria-label="&#x67E5;&#x770B;&#x8BE6;&#x60C5;">
                                    <i class="fas fa-eye"></i>
                                    <span>&#x67E5;&#x770B;</span>
                                </a>
                                {% if record.status == 'PAID' %}
                                <a href="{% url 'finance:finance_statement' record.contract.id %}"
                                   class="finance-action-btn finance-action-outline"
                                   title="&#x67E5;&#x770B;&#x8D26;&#x5355;"
                                   aria-label="&#x67E5;&#x770B;&#x8D26;&#x5355;">
                                    <i class="fas fa-file-invoice"></i>
                                    <span>&#x8D26;&#x5355;</span>
                                </a>
                                {% elif record.status == 'UNPAID' and can_pay_finance %}
                                <button type="button"
                                        class="finance-action-btn finance-action-accent"
                                        data-bs-toggle="modal"
                                        data-bs-target="#payModal{{ record.id }}"
                                        title="&#x53BB;&#x652F;&#x4ED8;"
                                        aria-label="&#x53BB;&#x652F;&#x4ED8;">
                                    <i class="fas fa-credit-card"></i>
                                    <span>&#x53BB;&#x652F;&#x4ED8;</span>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="ui-alert">&#x6CA1;&#x6709;&#x8D22;&#x52A1;&#x8BB0;&#x5F55;</div>
        {% endif %}
    </div>
</div>

{% for record in finance_records %}
{% if record.status == 'UNPAID' and can_pay_finance %}
<div class="modal fade" id="payModal{{ record.id }}" tabindex="-1" aria-labelledby="payModalLabel{{ record.id }}"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content ui-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="payModalLabel{{ record.id }}">&#x7F34;&#x8D39; - {{ record.contract }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'finance:finance_pay' record.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="ui-card ui-section mb-4">
                        <div class="finance-section-header">
                            <div class="ui-title">&#x8D22;&#x52A1;&#x660E;&#x7EC6;</div>
                            <span class="ui-text-muted">&#x4F9D;&#x5408;&#x540C;&#x7EDF;&#x8BA1;</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>&#x5E97;&#x94FA;&#x540D;&#x79F0;&#xFF1A;</strong>{{ record.contract.shop.name }}</p>
                                <p><strong>&#x8D39;&#x7528;&#x7C7B;&#x578B;&#xFF1A;</strong>{{ record.get_fee_type_display }}</p>
                                <p><strong>&#x672C;&#x671F;&#x5E94;&#x4ED8;&#x91D1;&#x989D;&#xFF1A;</strong>&#xA5;{{ record.amount }}</p>
                            </div>
                            <div class="col-md-6">
                                <p>
                                    <strong>&#x8D26;&#x5355;&#x5468;&#x671F;&#xFF1A;</strong>
                                    {{ record.billing_period_start|date:"Y-m-d" }}
                                    &#x81F3;
                                    {{ record.billing_period_end|date:"Y-m-d" }}
                                </p>
                                <p><strong>&#x7F34;&#x8D39;&#x5468;&#x671F;&#xFF1A;</strong>{{ record.contract.get_payment_cycle_display }}</p>
                                <p><strong>&#x62BC;&#x91D1;&#x91D1;&#x989D;&#xFF1A;</strong>&#xA5;{{ record.contract.deposit }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label for="payment_method{{ record.id }}">&#x9009;&#x62E9;&#x652F;&#x4ED8;&#x65B9;&#x5F0F;</label>
                        <select class="form-control ui-input" id="payment_method{{ record.id }}" name="payment_method" required>
                            <option value="">&#x8BF7;&#x9009;&#x62E9;&#x652F;&#x4ED8;&#x65B9;&#x5F0F;</option>
                            <option value="WECHAT">&#x5FAE;&#x4FE1;&#x652F;&#x4ED8;</option>
                            <option value="ALIPAY">&#x652F;&#x4ED8;&#x5B9D;</option>
                            <option value="BANK_TRANSFER">&#x94F6;&#x884C;&#x8F6C;&#x8D26;</option>
                            <option value="CASH">&#x73B0;&#x91D1;</option>
                        </select>
                    </div>

                    <div class="form-group mb-4">
                        <label for="transaction_id{{ record.id }}">&#x4EA4;&#x6613;&#x5355;&#x53F7;&#xFF08;&#x9009;&#x586B;&#xFF09;</label>
                        <input type="text" class="form-control ui-input" id="transaction_id{{ record.id }}" name="transaction_id"
                            placeholder="&#x8BF7;&#x8F93;&#x5165;&#x4EA4;&#x6613;&#x5355;&#x53F7;">
                    </div>

                    <div id="paymentQr{{ record.id }}" class="mb-4 hidden">
                        <div class="ui-card ui-section text-center">
                            <h6>&#x8BF7;&#x4F7F;&#x7528;&#x9009;&#x62E9;&#x7684;&#x652F;&#x4ED8;&#x65B9;&#x5F0F;&#x626B;&#x7801;&#x652F;&#x4ED8;</h6>
                            <div class="mt-2 mb-2">
                                <div
                                    style="width: 200px; height: 200px; background-color: var(--surface-2); margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); color: var(--text-muted);">
                                    <span id="paymentMethodText{{ record.id }}">&#x5FAE;&#x4FE1;&#x652F;&#x4ED8;&#x4E8C;&#x7EF4;&#x7801;</span>
                                </div>
                            </div>
                            <p class="ui-text-muted">&#x91D1;&#x989D;&#xFF1A;&#xA5;{{ record.amount }}</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="ui-btn ui-btn-outline" data-bs-dismiss="modal">&#x53D6;&#x6D88;</button>
                    <button type="button" id="showQrBtn{{ record.id }}" class="ui-btn ui-btn-outline me-2">&#x663E;&#x793A;&#x652F;&#x4ED8;&#x4E8C;&#x7EF4;&#x7801;</button>
                    <button type="submit" class="ui-btn ui-btn-primary">&#x786E;&#x8BA4;&#x652F;&#x4ED8;</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
    {% for record in finance_records %}
    {% if record.status == 'UNPAID' and can_pay_finance %}
    document.getElementById('showQrBtn{{ record.id }}').addEventListener('click', function () {
        const paymentMethod = document.getElementById('payment_method{{ record.id }}').value;
        const qrDiv = document.getElementById('paymentQr{{ record.id }}');
        const paymentMethodText = document.getElementById('paymentMethodText{{ record.id }}');

        if (!paymentMethod) {
            alert('&#x8BF7;&#x5148;&#x9009;&#x62E9;&#x652F;&#x4ED8;&#x65B9;&#x5F0F;');
            return;
        }

        const methodNames = {
            'WECHAT': '&#x5FAE;&#x4FE1;&#x652F;&#x4ED8;&#x4E8C;&#x7EF4;&#x7801;',
            'ALIPAY': '&#x652F;&#x4ED8;&#x5B9D;&#x4E8C;&#x7EF4;&#x7801;',
            'BANK_TRANSFER': '&#x94F6;&#x884C;&#x8F6C;&#x8D26;&#x4FE1;&#x606F;',
            'CASH': '&#x73B0;&#x91D1;&#x652F;&#x4ED8;&#x63D0;&#x793A;'
        };

        paymentMethodText.textContent = methodNames[paymentMethod] || '&#x652F;&#x4ED8;&#x4E8C;&#x7EF4;&#x7801;';
        qrDiv.classList.remove('hidden');
        qrDiv.classList.add('show');
    });
    {% endif %}
    {% endfor %}
</script>
{% endblock %}



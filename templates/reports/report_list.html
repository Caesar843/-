{% extends 'base.html' %}
{% load static %}

{% block title %}&#x62A5;&#x8868;&#x4E2D;&#x5FC3; - &#x5546;&#x573A;&#x5E97;&#x94FA;&#x667A;&#x80FD;&#x8FD0;&#x8425;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ui-tokens.css' %}">
<link rel="stylesheet" href="{% static 'css/ui-components.css' %}">
<link rel="stylesheet" href="{% static 'css/reports-center.css' %}">
{% endblock %}

{% block content %}
<div class="reports-page">
    <div class="reports-header">
        <span class="reports-title-bar"></span>
        <div>
            <div class="reports-title">&#x62A5;&#x8868;&#x4E2D;&#x5FC3;</div>
            <div class="reports-subtitle">&#x53EF;&#x89C6;&#x5316;&#x62A5;&#x8868;&#x751F;&#x6210;&#x4E0E;&#x5BFC;&#x51FA;</div>
        </div>
    </div>

    <div class="ui-card ui-section mb-4">
        <div class="reports-section-header">
            <div class="ui-title">&#x751F;&#x6210;&#x62A5;&#x8868;</div>
            <span class="ui-text-muted">&#x6839;&#x636E;&#x7B5B;&#x9009;&#x6761;&#x4EF6;&#x751F;&#x6210;&#x4E0E;&#x5BFC;&#x51FA;</span>
        </div>
        <form method="post" action="{% url 'reports:report_list' %}">
            {% csrf_token %}
            <div class="reports-form-grid">
                <div>
                    <label for="report_type" class="form-label">&#x62A5;&#x8868;&#x7C7B;&#x578B;</label>
                    <select class="form-select ui-input" id="report_type" name="report_type">
                        <option value="shop_operation" {% if report_type == "shop_operation" %}selected{% endif %}>&#x5E97;&#x94FA;&#x8FD0;&#x8425;&#x6570;&#x636E;&#x6C47;&#x603B;&#x8868;</option>
                        <option value="rent_collection" {% if report_type == "rent_collection" %}selected{% endif %}>&#x79DF;&#x91D1;&#x6536;&#x7F34;&#x60C5;&#x51B5;&#x62A5;&#x8868;</option>
                        <option value="business_type" {% if report_type == "business_type" %}selected{% endif %}>&#x4E1A;&#x6001;&#x5206;&#x5E03;&#x5206;&#x6790;&#x62A5;&#x8868;</option>
                        <option value="operation_efficiency" {% if report_type == "operation_efficiency" %}selected{% endif %}>&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x6548;&#x7387;&#x62A5;&#x8868;</option>
                    </select>
                </div>
                <div>
                    <label for="start_date" class="form-label">&#x5F00;&#x59CB;&#x65E5;&#x671F;</label>
                    <input type="date" class="form-control ui-input" id="start_date" name="start_date" value="{{ start_date }}">
                </div>
                <div>
                    <label for="end_date" class="form-label">&#x7ED3;&#x675F;&#x65E5;&#x671F;</label>
                    <input type="date" class="form-control ui-input" id="end_date" name="end_date" value="{{ end_date }}">
                </div>
                <div>
                    <label for="shop_id" class="form-label">&#x5E97;&#x94FA;</label>
                    <select class="form-select ui-input" id="shop_id" name="shop_id">
                        <option value="">&#x5168;&#x90E8;&#x5E97;&#x94FA;</option>
                        {% for shop in shops %}
                        <option value="{{ shop.id }}" {% if shop_id == shop.id|stringformat:"s" %}selected{% endif %}>{{ shop.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="export_format" class="form-label">&#x5BFC;&#x51FA;&#x683C;&#x5F0F;</label>
                    <select class="form-select ui-input" id="export_format" name="export_format">
                        <option value="">&#x4EC5;&#x9884;&#x89C8;</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                        <option value="pdf">PDF</option>
                    </select>
                </div>
            </div>
            <div class="reports-actions">
                <button type="submit" class="ui-btn ui-btn-primary">&#x751F;&#x6210;&#x62A5;&#x8868;</button>
            </div>
        </form>
    </div>

    {% if report_data %}
    <div class="ui-card ui-section mb-4">
        <div class="reports-section-header">
            <div class="ui-title">&#x62A5;&#x8868;&#x9884;&#x89C8;</div>
            <span class="ui-text-muted">&#x751F;&#x6210;&#x65F6;&#x95F4;&#xFF1A;{{ now }}</span>
        </div>

        <div class="reports-preview-title">
            {% if report_type == "shop_operation" %}
            <h3>&#x5E97;&#x94FA;&#x8FD0;&#x8425;&#x6570;&#x636E;&#x6C47;&#x603B;&#x8868;</h3>
            {% elif report_type == "rent_collection" %}
            <h3>&#x79DF;&#x91D1;&#x6536;&#x7F34;&#x60C5;&#x51B5;&#x62A5;&#x8868;</h3>
            {% elif report_type == "business_type" %}
            <h3>&#x4E1A;&#x6001;&#x5206;&#x5E03;&#x5206;&#x6790;&#x62A5;&#x8868;</h3>
            {% elif report_type == "operation_efficiency" %}
            <h3>&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x6548;&#x7387;&#x62A5;&#x8868;</h3>
            {% endif %}
            <p class="ui-text-muted">&#x65E5;&#x671F;&#x8303;&#x56F4;&#xFF1A;{{ start_date }} &#x81F3; {{ end_date }}</p>
        </div>

        {% if report_type == "shop_operation" %}
        <div class="reports-table-card">
            <div class="table-responsive">
                <table class="ui-table">
                    <thead>
                        <tr>
                            <th>&#x5E97;&#x94FA;&#x540D;&#x79F0;</th>
                            <th>&#x4E1A;&#x6001;&#x7C7B;&#x578B;</th>
                            <th>&#x7ECF;&#x8425;&#x9762;&#x79EF;</th>
                            <th>&#x79DF;&#x91D1;</th>
                            <th>&#x5BA2;&#x6D41;&#x91CF;</th>
                            <th>&#x9500;&#x552E;&#x989D;</th>
                            <th>&#x4EA4;&#x6613;&#x7B14;&#x6570;</th>
                            <th>&#x5BA2;&#x5355;&#x4EF7;</th>
                            <th>&#x8F6C;&#x5316;&#x7387;</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for shop in report_data.summary_data %}
                        <tr>
                            <td>{{ shop.shop_name }}</td>
                            <td>{{ shop.business_type }}</td>
                            <td>{{ shop.area }} &#x5E73;&#x65B9;&#x7C73;</td>
                            <td>&#xA5;{{ shop.rent }}/&#x6708;</td>
                            <td>{{ shop.foot_traffic }}</td>
                            <td>&#xA5;{{ shop.sales_amount }}</td>
                            <td>{{ shop.transaction_count }}</td>
                            <td>&#xA5;{{ shop.avg_transaction_value|floatformat:2 }}</td>
                            <td>{{ shop.conversion_rate|floatformat:2 }}%</td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td><strong>&#x603B;&#x8BA1;</strong></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td><strong>{{ report_data.total_foot_traffic }}</strong></td>
                            <td><strong>&#xA5;{{ report_data.total_sales }}</strong></td>
                            <td><strong>{{ report_data.total_transactions }}</strong></td>
                            <td><strong>&#xA5;{{ report_data.total_avg_transaction_value|floatformat:2 }}</strong></td>
                            <td><strong>{{ report_data.total_conversion_rate|floatformat:2 }}%</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% elif report_type == "rent_collection" %}
        <div class="reports-table-card">
            <div class="table-responsive">
                <table class="ui-table">
                    <thead>
                        <tr>
                            <th>&#x5E97;&#x94FA;&#x540D;&#x79F0;</th>
                            <th>&#x5408;&#x540C;ID</th>
                            <th>&#x5408;&#x540C;&#x671F;&#x95F4;</th>
                            <th>&#x6708;&#x79DF;&#x91D1;</th>
                            <th>&#x5E94;&#x7F34;&#x6708;&#x6570;</th>
                            <th>&#x5E94;&#x7F34;&#x79DF;&#x91D1;</th>
                            <th>&#x5DF2;&#x6536;&#x79DF;&#x91D1;</th>
                            <th>&#x672A;&#x6536;&#x79DF;&#x91D1;</th>
                            <th>&#x6536;&#x7F34;&#x7387;</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in report_data.report_data %}
                        <tr>
                            <td>{{ item.shop_name }}</td>
                            <td>{{ item.contract_id }}</td>
                            <td>{{ item.start_date }} &#x81F3; {{ item.end_date }}</td>
                            <td>&#xA5;{{ item.monthly_rent }}</td>
                            <td>{{ item.months }} &#x4E2A;&#x6708;</td>
                            <td>&#xA5;{{ item.rent_due }}</td>
                            <td>&#xA5;{{ item.rent_collected }}</td>
                            <td>&#xA5;{{ item.rent_outstanding }}</td>
                            <td>{{ item.collection_rate|floatformat:2 }}%</td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td><strong>&#x603B;&#x8BA1;</strong></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td><strong>&#xA5;{{ report_data.total_rent_due }}</strong></td>
                            <td><strong>&#xA5;{{ report_data.total_rent_collected }}</strong></td>
                            <td><strong>&#xA5;{{ report_data.total_rent_outstanding }}</strong></td>
                            <td><strong>{{ report_data.total_collection_rate|floatformat:2 }}%</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% elif report_type == "business_type" %}
        <div class="reports-table-card">
            <div class="table-responsive">
                <table class="ui-table">
                    <thead>
                        <tr>
                            <th>&#x4E1A;&#x6001;&#x7C7B;&#x578B;</th>
                            <th>&#x5E97;&#x94FA;&#x6570;&#x91CF;</th>
                            <th>&#x5360;&#x6BD4;</th>
                            <th>&#x603B;&#x9762;&#x79EF;</th>
                            <th>&#x9762;&#x79EF;&#x5360;&#x6BD4;</th>
                            <th>&#x603B;&#x5BA2;&#x6D41;&#x91CF;</th>
                            <th>&#x603B;&#x9500;&#x552E;&#x989D;</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for business_type, data in report_data.business_type_data.items %}
                        <tr>
                            <td>{{ business_type }}</td>
                            <td>{{ data.shop_count }}</td>
                            <td>{{ data.shop_percentage|floatformat:2 }}%</td>
                            <td>{{ data.area }} &#x5E73;&#x65B9;&#x7C73;</td>
                            <td>{{ data.area_percentage|floatformat:2 }}%</td>
                            <td>{{ data.foot_traffic }}</td>
                            <td>&#xA5;{{ data.sales }}</td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td><strong>&#x603B;&#x8BA1;</strong></td>
                            <td><strong>{{ report_data.total_shops }}</strong></td>
                            <td><strong>100%</strong></td>
                            <td><strong>{{ report_data.total_area }} &#x5E73;&#x65B9;&#x7C73;</strong></td>
                            <td><strong>100%</strong></td>
                            <td><strong>{{ report_data.total_foot_traffic }}</strong></td>
                            <td><strong>&#xA5;{{ report_data.total_sales }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% elif report_type == "operation_efficiency" %}
        <div class="reports-table-card">
            <div class="table-responsive">
                <table class="ui-table">
                    <thead>
                        <tr>
                            <th>&#x4E8B;&#x52A1;&#x7C7B;&#x578B;</th>
                            <th>&#x603B;&#x5904;&#x7406;&#x91CF;</th>
                            <th>&#x5E73;&#x5747;&#x5904;&#x7406;&#x65F6;&#x95F4;</th>
                            <th>&#x6700;&#x77ED;&#x5904;&#x7406;&#x65F6;&#x95F4;</th>
                            <th>&#x6700;&#x957F;&#x5904;&#x7406;&#x65F6;&#x95F4;</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in report_data.report_data %}
                        <tr>
                            <td>{{ item.transaction_type }}</td>
                            <td>{{ item.total_transactions }}</td>
                            <td>{{ item.avg_processing_time }} &#x5C0F;&#x65F6;</td>
                            <td>{{ item.min_processing_time }} &#x5C0F;&#x65F6;</td>
                            <td>{{ item.max_processing_time }} &#x5C0F;&#x65F6;</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

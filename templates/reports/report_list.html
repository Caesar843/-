{% extends 'base.html' %}

{% block title %}æŠ¥è¡¨ç®¡ç† - å•†åœºåº—é“ºæ™ºèƒ½è¿è¥ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mt-4 mb-4">ğŸ“‹ å¯è§†åŒ–æŠ¥è¡¨ç”Ÿæˆä¸å¯¼å‡º</h1>

        <!-- æŠ¥è¡¨ç”Ÿæˆ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">ç”ŸæˆæŠ¥è¡¨</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'reports:report_list' %}">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="report_type" class="form-label">æŠ¥è¡¨ç±»å‹</label>
                            <select class="form-select" id="report_type" name="report_type">
                                <option value="shop_operation" {% if report_type == "shop_operation" %}selected{% endif %}>åº—é“ºè¿è¥æ•°æ®æ±‡æ€»è¡¨</option>
                                <option value="rent_collection" {% if report_type == "rent_collection" %}selected{% endif %}>ç§Ÿé‡‘æ”¶ç¼´æƒ…å†µæŠ¥è¡¨</option>
                                <option value="business_type" {% if report_type == "business_type" %}selected{% endif %}>ä¸šæ€åˆ†å¸ƒåˆ†ææŠ¥è¡¨</option>
                                <option value="operation_efficiency" {% if report_type == "operation_efficiency" %}selected{% endif %}>äº‹åŠ¡å¤„ç†æ•ˆç‡æŠ¥è¡¨</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">ç»“æŸæ—¥æœŸ</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                        </div>
                        <div class="col-md-3">
                            <label for="shop_id" class="form-label">åº—é“º</label>
                            <select class="form-select" id="shop_id" name="shop_id">
                                <option value="">å…¨éƒ¨åº—é“º</option>
                                {% for shop in shops %}
                                <option value="{{ shop.id }}" {% if shop_id == shop.id|stringformat:"s" %}selected{% endif %}>{{ shop.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="export_format" class="form-label">å¯¼å‡ºæ ¼å¼</label>
                            <select class="form-select" id="export_format" name="export_format">
                                <option value="">ä»…é¢„è§ˆ</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                                <option value="pdf">PDF</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">ç”ŸæˆæŠ¥è¡¨</button>
                </form>
            </div>
        </div>

        <!-- æŠ¥è¡¨é¢„è§ˆ -->
        {% if report_data %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">æŠ¥è¡¨é¢„è§ˆ</h5>
                <div class="float-end">
                    <small class="text-muted">ç”Ÿæˆæ—¶é—´: {{ now }}</small>
                </div>
            </div>
            <div class="card-body">
                <!-- æŠ¥è¡¨æ ‡é¢˜ -->
                <div class="text-center mb-4">
                    {% if report_type == "shop_operation" %}
                    <h3>åº—é“ºè¿è¥æ•°æ®æ±‡æ€»è¡¨</h3>
                    {% elif report_type == "rent_collection" %}
                    <h3>ç§Ÿé‡‘æ”¶ç¼´æƒ…å†µæŠ¥è¡¨</h3>
                    {% elif report_type == "business_type" %}
                    <h3>ä¸šæ€åˆ†å¸ƒåˆ†ææŠ¥è¡¨</h3>
                    {% elif report_type == "operation_efficiency" %}
                    <h3>äº‹åŠ¡å¤„ç†æ•ˆç‡æŠ¥è¡¨</h3>
                    {% endif %}
                    <p>æ—¥æœŸèŒƒå›´: {{ start_date }} è‡³ {{ end_date }}</p>
                </div>

                <!-- åº—é“ºè¿è¥æ•°æ®æ±‡æ€»è¡¨ -->
                {% if report_type == "shop_operation" %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>åº—é“ºåç§°</th>
                                <th>ä¸šæ€ç±»å‹</th>
                                <th>ç»è¥é¢ç§¯</th>
                                <th>ç§Ÿé‡‘</th>
                                <th>å®¢æµé‡</th>
                                <th>é”€å”®é¢</th>
                                <th>äº¤æ˜“ç¬”æ•°</th>
                                <th>å®¢å•ä»·</th>
                                <th>è½¬åŒ–ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shop in report_data.summary_data %}
                            <tr>
                                <td>{{ shop.shop_name }}</td>
                                <td>{{ shop.business_type }}</td>
                                <td>{{ shop.area }} å¹³æ–¹ç±³</td>
                                <td>Â¥{{ shop.rent }}/æœˆ</td>
                                <td>{{ shop.foot_traffic }}</td>
                                <td>Â¥{{ shop.sales_amount }}</td>
                                <td>{{ shop.transaction_count }}</td>
                                <td>Â¥{{ shop.avg_transaction_value|floatformat:2 }}</td>
                                <td>{{ shop.conversion_rate|floatformat:2 }}%</td>
                            </tr>
                            {% endfor %}
                            <!-- æ€»è®¡è¡Œ -->
                            <tr class="table-primary">
                                <td><strong>æ€»è®¡</strong></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td><strong>{{ report_data.total_foot_traffic }}</strong></td>
                                <td><strong>Â¥{{ report_data.total_sales }}</strong></td>
                                <td><strong>{{ report_data.total_transactions }}</strong></td>
                                <td><strong>Â¥{{ report_data.total_avg_transaction_value|floatformat:2 }}</strong></td>
                                <td><strong>{{ report_data.total_conversion_rate|floatformat:2 }}%</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ç§Ÿé‡‘æ”¶ç¼´æƒ…å†µæŠ¥è¡¨ -->
                {% elif report_type == "rent_collection" %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>åº—é“ºåç§°</th>
                                <th>åˆåŒID</th>
                                <th>åˆåŒæœŸé—´</th>
                                <th>æœˆç§Ÿé‡‘</th>
                                <th>åº”ç¼´æœˆæ•°</th>
                                <th>åº”ç¼´ç§Ÿé‡‘</th>
                                <th>å·²æ”¶ç§Ÿé‡‘</th>
                                <th>æœªæ”¶ç§Ÿé‡‘</th>
                                <th>æ”¶ç¼´ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in report_data.report_data %}
                            <tr>
                                <td>{{ item.shop_name }}</td>
                                <td>{{ item.contract_id }}</td>
                                <td>{{ item.start_date }} è‡³ {{ item.end_date }}</td>
                                <td>Â¥{{ item.monthly_rent }}</td>
                                <td>{{ item.months }} ä¸ªæœˆ</td>
                                <td>Â¥{{ item.rent_due }}</td>
                                <td>Â¥{{ item.rent_collected }}</td>
                                <td>Â¥{{ item.rent_outstanding }}</td>
                                <td>{{ item.collection_rate|floatformat:2 }}%</td>
                            </tr>
                            {% endfor %}
                            <!-- æ€»è®¡è¡Œ -->
                            <tr class="table-primary">
                                <td><strong>æ€»è®¡</strong></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td><strong>Â¥{{ report_data.total_rent_due }}</strong></td>
                                <td><strong>Â¥{{ report_data.total_rent_collected }}</strong></td>
                                <td><strong>Â¥{{ report_data.total_rent_outstanding }}</strong></td>
                                <td><strong>{{ report_data.total_collection_rate|floatformat:2 }}%</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ä¸šæ€åˆ†å¸ƒåˆ†ææŠ¥è¡¨ -->
                {% elif report_type == "business_type" %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ä¸šæ€ç±»å‹</th>
                                <th>åº—é“ºæ•°é‡</th>
                                <th>å æ¯”</th>
                                <th>æ€»é¢ç§¯</th>
                                <th>é¢ç§¯å æ¯”</th>
                                <th>æ€»å®¢æµé‡</th>
                                <th>æ€»é”€å”®é¢</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for business_type, data in report_data.business_type_data.items %}
                            <tr>
                                <td>{{ business_type }}</td>
                                <td>{{ data.shop_count }}</td>
                                <td>{{ data.shop_percentage|floatformat:2 }}%</td>
                                <td>{{ data.area }} å¹³æ–¹ç±³</td>
                                <td>{{ data.area_percentage|floatformat:2 }}%</td>
                                <td>{{ data.foot_traffic }}</td>
                                <td>Â¥{{ data.sales }}</td>
                            </tr>
                            {% endfor %}
                            <!-- æ€»è®¡è¡Œ -->
                            <tr class="table-primary">
                                <td><strong>æ€»è®¡</strong></td>
                                <td><strong>{{ report_data.total_shops }}</strong></td>
                                <td><strong>100%</strong></td>
                                <td><strong>{{ report_data.total_area }} å¹³æ–¹ç±³</strong></td>
                                <td><strong>100%</strong></td>
                                <td><strong>{{ report_data.total_foot_traffic }}</strong></td>
                                <td><strong>Â¥{{ report_data.total_sales }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- äº‹åŠ¡å¤„ç†æ•ˆç‡æŠ¥è¡¨ -->
                {% elif report_type == "operation_efficiency" %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>äº‹åŠ¡ç±»å‹</th>
                                <th>æ€»å¤„ç†é‡</th>
                                <th>å¹³å‡å¤„ç†æ—¶é—´</th>
                                <th>æœ€çŸ­å¤„ç†æ—¶é—´</th>
                                <th>æœ€é•¿å¤„ç†æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in report_data.report_data %}
                            <tr>
                                <td>{{ item.transaction_type }}</td>
                                <td>{{ item.total_transactions }}</td>
                                <td>{{ item.avg_processing_time }} å°æ—¶</td>
                                <td>{{ item.min_processing_time }} å°æ—¶</td>
                                <td>{{ item.max_processing_time }} å°æ—¶</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}&#x7F16;&#x8F91;&#x5E97;&#x94FA;{% else %}&#x65B0;&#x5EFA;&#x5E97;&#x94FA;{% endif %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ui-tokens.css' %}">
<link rel="stylesheet" href="{% static 'css/ui-components.css' %}">
<link rel="stylesheet" href="{% static 'css/store-management.css' %}">
{% endblock %}

{% block content %}
<div class="container store-page">
    <div class="store-header">
        <div class="store-title-wrap">
            <span class="store-title-bar"></span>
            <div>
                {% if form.instance.pk %}
                <div class="store-title">&#x7F16;&#x8F91;&#x5E97;&#x94FA;</div>
                <div class="store-subtitle">&#x66F4;&#x65B0;&#x5E97;&#x94FA;&#x57FA;&#x7840;&#x4FE1;&#x606F;</div>
                {% else %}
                <div class="store-title">&#x65B0;&#x5EFA;&#x5E97;&#x94FA;</div>
                <div class="store-subtitle">&#x586B;&#x5199;&#x5E97;&#x94FA;&#x57FA;&#x7840;&#x4FE1;&#x606F;</div>
                {% endif %}
            </div>
        </div>
        <div class="store-actions">
            <a href="{% url 'store:shop_list' %}" class="ui-btn ui-btn-outline">&#x8FD4;&#x56DE;&#x5217;&#x8868;</a>
        </div>
    </div>

    <div class="ui-card ui-section store-form-card">
        <form method="post" class="store-form">
            {% csrf_token %}
            <div class="store-form-grid">
                <div class="form-group">
                    <label for="id_name" class="form-label">&#x5E97;&#x94FA;&#x540D;&#x79F0;</label>
                    {{ form.name }}
                </div>
                <div class="form-group">
                    <label for="id_business_type" class="form-label">&#x4E1A;&#x6001;&#x7C7B;&#x578B;</label>
                    {{ form.business_type }}
                </div>
                <div class="form-group">
                    <label for="id_area" class="form-label">&#x7ECF;&#x8425;&#x9762;&#x79EF; (&#x33A1;)</label>
                    {{ form.area }}
                </div>
                <div class="form-group">
                    <label for="id_rent" class="form-label">&#x79DF;&#x91D1; (&#x5143;/&#x6708;)</label>
                    {{ form.rent }}
                </div>
                <div class="form-group">
                    <label for="id_contact_person" class="form-label">&#x8054;&#x7CFB;&#x4EBA;</label>
                    {{ form.contact_person }}
                </div>
                <div class="form-group">
                    <label for="id_contact_phone" class="form-label">&#x8054;&#x7CFB;&#x65B9;&#x5F0F;</label>
                    {{ form.contact_phone }}
                </div>
                <div class="form-group">
                    <label for="id_org_unit" class="form-label">&#x7EC4;&#x7EC7;&#x5355;&#x5143;</label>
                    {{ form.org_unit }}
                </div>
                <div class="form-group">
                    <label for="entry_date_display" class="form-label">&#x5165;&#x9A7B;&#x65E5;&#x671F;</label>
                    <input type="date" class="form-control ui-input" id="entry_date_display" value="{{ form.instance.entry_date|date:'Y-m-d' }}">
                    <input type="hidden" id="id_entry_date" name="entry_date" value="{{ form.instance.entry_date|date:'Y-m-d' }}">
                    {% if form.entry_date.errors %}
                    <div class="ui-alert mt-2">{{ form.entry_date.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group store-form-full">
                    <label for="id_description" class="form-label">&#x63CF;&#x8FF0;</label>
                    {{ form.description }}
                </div>
            </div>
            <div class="store-form-actions">
                <a href="{% url 'store:shop_list' %}" class="ui-btn ui-btn-outline">&#x53D6;&#x6D88;</a>
                <button type="submit" class="ui-btn ui-btn-primary">&#x4FDD;&#x5B58;</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('entry_date_display');
        const hiddenInput = document.getElementById('id_entry_date');

        if (dateInput && hiddenInput) {
            const syncHidden = function () {
                hiddenInput.value = dateInput.value || '';
            };
            dateInput.addEventListener('change', syncHidden);
            syncHidden();
        }

        const form = document.querySelector('form');
        if (!form) return;

        form.addEventListener('submit', function (e) {
            const entryDate = dateInput ? dateInput.value : '';

            if (!entryDate) {
                e.preventDefault();
                alert('\u8bf7\u9009\u62e9\u5b8c\u6574\u7684\u5165\u9a7b\u65e5\u671f');
                return;
            }

            const selectedDate = new Date(entryDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate > today) {
                e.preventDefault();
                alert('\u5165\u9a7b\u65e5\u671f\u4e0d\u80fd\u662f\u672a\u6765\u65e5\u671f');
                return;
            }

            if (hiddenInput) {
                hiddenInput.value = entryDate;
            }
        });
    });
</script>
{% endblock %}

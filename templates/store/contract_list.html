{% extends "base.html" %}
{% load static %}

{% block title %}合同列表 - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ui-tokens.css' %}">
<link rel="stylesheet" href="{% static 'css/ui-components.css' %}">
<link rel="stylesheet" href="{% static 'css/store-management.css' %}">
<style>
    .action-stack {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
    }

    .approval-inline {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
    }

    .approval-input {
        min-width: 170px;
        max-width: 240px;
        height: 32px;
        padding: 0 10px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        background-color: #ffffff;
        color: #0f172a;
    }

    .approval-input:focus-visible {
        outline: 2px solid #2563eb;
        outline-offset: 1px;
    }

    .approval-progress {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 56px;
        height: 26px;
        padding: 0 8px;
        border-radius: 999px;
        background: #eff6ff;
        color: #1d4ed8;
        font-size: 12px;
        font-weight: 600;
    }

    .pending-hint {
        color: #64748b;
        font-size: 12px;
    }

    .js-once-submit button[disabled] {
        opacity: 0.75;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container store-page">
    <div class="store-header">
        <div class="store-title-wrap">
            <span class="store-title-bar"></span>
            <div>
                <div class="store-title">合同管理</div>
                <div class="store-subtitle">合同状态与审批流转一览</div>
            </div>
        </div>
        {% if user.is_authenticated %}
        <div class="store-actions">
            <a href="{% url 'store:contract_expiry' %}" class="ui-btn ui-btn-outline">合同到期提醒</a>
            <a href="{% url 'store:contract_create' %}" class="ui-btn ui-btn-primary">新建合同</a>
        </div>
        {% endif %}
    </div>

    {% if contracts %}
    <div class="ui-card ui-section store-table-card">
        <div class="table-responsive">
            <table class="ui-table">
                <thead>
                    <tr>
                        <th>店铺名称</th>
                        <th>开始日期</th>
                        <th>结束日期</th>
                        <th>月租金(元)</th>
                        <th>状态</th>
                        <th>审批进度</th>
                        <th>当前节点</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contract in contracts %}
                    <tr>
                        <td>{{ contract.shop.name }}</td>
                        <td>{{ contract.start_date }}</td>
                        <td>{{ contract.end_date }}</td>
                        <td class="numeric">{{ contract.monthly_rent }}</td>
                        <td>
                            {% if contract.status == 'ACTIVE' %}
                            <span class="status-badge success">{{ contract.get_status_display }}</span>
                            {% elif contract.status == 'DRAFT' %}
                            <span class="status-badge warning">{{ contract.get_status_display }}</span>
                            {% elif contract.status == 'TERMINATED' or contract.status == 'EXPIRED' %}
                            <span class="status-badge danger">{{ contract.get_status_display }}</span>
                            {% else %}
                            <span class="status-badge neutral">{{ contract.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="approval-progress">{{ contract.approval_progress_text }}</span>
                        </td>
                        <td>
                            <div>{{ contract.approval_current_node }}</div>
                            {% if contract.approval_pending_actor %}
                            <div class="pending-hint">待 {{ contract.approval_pending_actor }} 处理</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_authenticated %}
                            <div class="action-stack">
                                <a href="{% url 'store:contract_detail' contract.pk %}" class="ui-btn ui-btn-outline ui-btn-sm">详情</a>

                                {% if contract.status == 'DRAFT' and can_submit_review %}
                                <form method="post" action="{% url 'store:contract_submit_review' contract.pk %}" class="approval-inline js-once-submit">
                                    {% csrf_token %}
                                    <button type="submit" class="ui-btn ui-btn-primary ui-btn-sm">提交审批</button>
                                </form>
                                {% endif %}

                                {% if contract.status == 'PENDING_REVIEW' and can_review_contract and contract.can_current_user_review %}
                                <form method="post" action="{% url 'store:contract_approve' contract.pk %}" class="approval-inline js-once-submit">
                                    {% csrf_token %}
                                    <input type="text"
                                           name="comment"
                                           class="approval-input"
                                           maxlength="200"
                                           placeholder="审批意见（可选）"
                                           aria-label="审批意见（可选）">
                                    <button type="submit" class="ui-btn ui-btn-success ui-btn-sm">审批通过</button>
                                </form>
                                <form method="post" action="{% url 'store:contract_reject' contract.pk %}" class="approval-inline js-once-submit">
                                    {% csrf_token %}
                                    <input type="text"
                                           name="reason"
                                           class="approval-input"
                                           maxlength="200"
                                           required
                                           placeholder="请输入驳回原因"
                                           aria-label="驳回原因">
                                    <button type="submit" class="ui-btn ui-btn-warning ui-btn-sm">驳回</button>
                                </form>
                                {% endif %}

                                {% if contract.status == 'APPROVED' %}
                                <form method="post" action="{% url 'store:contract_activate' contract.pk %}" class="approval-inline js-once-submit">
                                    {% csrf_token %}
                                    <button type="submit" class="ui-btn ui-btn-success ui-btn-sm">激活</button>
                                </form>
                                {% elif contract.status == 'ACTIVE' %}
                                <form method="post" action="{% url 'store:contract_terminate' contract.pk %}" class="approval-inline js-once-submit">
                                    {% csrf_token %}
                                    <button type="submit" class="ui-btn ui-btn-warning ui-btn-sm">终止</button>
                                </form>
                                {% endif %}

                                <a href="{% url 'finance:finance_list' %}?contract_id={{ contract.pk }}" class="ui-btn ui-btn-info ui-btn-sm">财务记录</a>

                                {% if contract.status == 'TERMINATED' or contract.status == 'EXPIRED' %}
                                <form method="post" action="{% url 'store:contract_delete' contract.pk %}" class="approval-inline js-once-submit">
                                    {% csrf_token %}
                                    <button type="submit" class="ui-btn ui-btn-outline ui-btn-sm">归档</button>
                                </form>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="ui-alert">
        <strong>暂无合同</strong>，请点击上方按钮创建新合同。
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('form.js-once-submit');
        forms.forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (form.dataset.submitted === '1') {
                    event.preventDefault();
                    return;
                }
                form.dataset.submitted = '1';
                form.querySelectorAll('button[type="submit"]').forEach(function (button) {
                    button.disabled = true;
                });
            });
        });
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>缴费提醒</h1>
    
    <div class="mb-4">
        <form method="get" class="d-flex gap-2">
            <input type="number" class="form-control" name="days" placeholder="提醒天数" value="{{ days }}">
            <button type="submit" class="btn btn-primary">查询</button>
            <a href="{% url 'finance:finance_reminders' %}" class="btn btn-secondary">重置</a>
        </form>
    </div>
    
    {% if reminders %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title">即将到期的费用 ({{ days }}天内)</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>合同</th>
                        <th>费用类型</th>
                        <th>金额</th>
                        <th>账单周期</th>
                        <th>到期日期</th>
                        <th>剩余天数</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reminder in reminders %}
                    <tr>
                        <td>{{ reminder.contract.shop.name }}</td>
                        <td>
                            {% if reminder.fee_type == 'RENT' %}租金
                            {% elif reminder.fee_type == 'PROPERTY_FEE' %}物业费
                            {% elif reminder.fee_type == 'UTILITY_FEE' %}水电费
                            {% elif reminder.fee_type == 'OTHER' %}其他费用
                            {% endif %}
                        </td>
                        <td>¥{{ reminder.amount }}</td>
                        <td>{{ reminder.billing_period_start }} 至 {{ reminder.billing_period_end }}</td>
                        <td>{{ reminder.billing_period_end }}</td>
                        <td>
                            {% if reminder.days_until_due <= 3 %}
                                <span class="badge bg-danger">{{ reminder.days_until_due }}天</span>
                            {% elif reminder.days_until_due <= 7 %}
                                <span class="badge bg-warning">{{ reminder.days_until_due }}天</span>
                            {% else %}
                                <span class="badge bg-info">{{ reminder.days_until_due }}天</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'finance:finance_detail' reminder.id %}" class="btn btn-sm btn-info">查看详情</a>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#paymentModal" data-record-id="{{ reminder.id }}">立即缴费</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        暂无{{ days }}天内到期的费用
    </div>
    {% endif %}
    
    <div class="mb-4">
        <a href="{% url 'finance:finance_list' %}" class="btn btn-secondary">返回列表</a>
    </div>
</div>

<!-- 缴费模态框 -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">缴费</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm" method="post" action="{% url 'finance:finance_pay' 0 %}">
                    {% csrf_token %}
                    <input type="hidden" name="record_id" id="recordId">
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">缴费方式</label>
                        <select class="form-select" id="paymentMethod" name="payment_method" required>
                            <option value="">请选择缴费方式</option>
                            <option value="WECHAT">微信支付</option>
                            <option value="ALIPAY">支付宝</option>
                            <option value="BANK_TRANSFER">银行转账</option>
                            <option value="CASH">现金</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transactionId" class="form-label">交易单号</label>
                        <input type="text" class="form-control" id="transactionId" name="transaction_id" placeholder="请输入交易单号">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" form="paymentForm" class="btn btn-primary">确认缴费</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 初始化缴费模态框
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const recordId = button.getAttribute('data-record-id');
            const form = document.getElementById('paymentForm');
            const action = form.action.replace(/\/0\/$/, `/${recordId}/`);
            form.action = action;
            document.getElementById('recordId').value = recordId;
        });
    }
</script>
{% endblock %}
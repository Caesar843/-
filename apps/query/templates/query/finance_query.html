{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">ğŸ’° è´¢åŠ¡æŸ¥è¯¢</h1>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">æŸ¥è¯¢æ¡ä»¶</h5>
            <form method="get" action="{% url 'query:finance_query' %}">
                <div class="form-row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="fee_type">è´¹ç”¨ç±»å‹</label>
                            <select class="form-control" id="fee_type" name="fee_type">
                                <option value="">-- å…¨éƒ¨è´¹ç”¨ç±»å‹ --</option>
                                <option value="RENT" {% if is_rent %}selected{% endif %}>ç§Ÿé‡‘</option>
                                <option value="PROPERTY_FEE" {% if is_property_fee %}selected{% endif %}>ç‰©ä¸šè´¹</option>
                                <option value="UTILITY_FEE" {% if is_utility_fee %}selected{% endif %}>æ°´ç”µè´¹</option>
                                <option value="OTHER" {% if is_other_fee %}selected{% endif %}>å…¶ä»–è´¹ç”¨</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="status">çŠ¶æ€</label>
                            <select class="form-control" id="status" name="status">
                                <option value="">-- å…¨éƒ¨çŠ¶æ€ --</option>
                                <option value="UNPAID" {% if is_unpaid %}selected{% endif %}>æœªæ”¯ä»˜</option>
                                <option value="PAID" {% if is_paid %}selected{% endif %}>å·²æ”¯ä»˜</option>
                                <option value="VOID" {% if is_void %}selected{% endif %}>å·²ä½œåºŸ</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="period">æ—¶é—´èŒƒå›´</label>
                            <select class="form-control" id="period" name="period">
                                <option value="week" {% if is_week %}selected{% endif %}>æœ€è¿‘7å¤©</option>
                                <option value="month" {% if is_month %}selected{% endif %}>æœ€è¿‘30å¤©</option>
                                <option value="quarter" {% if is_quarter %}selected{% endif %}>æœ€è¿‘90å¤©</option>
                                <option value="year" {% if is_year %}selected{% endif %}>æœ€è¿‘1å¹´</option>
                                <option value="custom" {% if is_custom %}selected{% endif %}>è‡ªå®šä¹‰èŒƒå›´</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ï¼Œä»…åœ¨é€‰æ‹©"è‡ªå®šä¹‰èŒƒå›´"æ—¶æ˜¾ç¤º -->
                <div id="custom_date_range" {% if not is_custom %}style="display: none;"{% endif %}>
                    <div class="form-row mt-2">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="start_date">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="end_date">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row mt-3">
                    <div class="col-md-12 text-right">
                        <button type="submit" class="btn btn-primary">æŸ¥è¯¢</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- è´¹ç”¨æ”¶ç¼´æ˜ç»† -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="card-title">è´¹ç”¨æ”¶ç¼´æ˜ç»†</h5>
        </div>
        <div class="card-body">
            {% if finance_records %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>è®°å½•ID</th>
                            <th>åº—é“ºåç§°</th>
                            <th>è´¹ç”¨ç±»å‹</th>
                            <th>é‡‘é¢</th>
                            <th>è´¦å•å‘¨æœŸ</th>
                            <th>çŠ¶æ€</th>
                            <th>ç¼´è´¹æ–¹å¼</th>
                            <th>ç¼´è´¹æ—¶é—´</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in finance_records %}
                        <tr>
                            <td>{{ record.id }}</td>
                            <td>{{ record.contract.shop.name }}</td>
                            <td>{{ record.get_fee_type_display }}</td>
                            <td>Â¥{{ record.amount }}</td>
                            <td>{{ record.billing_period_start|date:"Y-m-d" }} è‡³ {{ record.billing_period_end|date:"Y-m-d" }}</td>
                            <td>
                                <span class="badge {% if record.status == 'PAID' %}badge-success{% elif record.status == 'UNPAID' %}badge-danger{% else %}badge-secondary{% endif %}">
                                    {{ record.get_status_display }}
                                </span>
                            </td>
                            <td>{{ record.get_payment_method_display|default:"æœªæ”¯ä»˜" }}</td>
                            <td>{{ record.paid_at|date:"Y-m-d H:i"|default:"æœªæ”¯ä»˜" }}</td>
                            <td>{{ record.created_at|date:"Y-m-d H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">æš‚æ— è´¹ç”¨æ”¶ç¼´æ˜ç»†</p>
            {% endif %}
        </div>
    </div>
    
    <!-- æœªç¼´è´¹ç”¨ç»Ÿè®¡ -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="card-title">æœªç¼´è´¹ç”¨ç»Ÿè®¡</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title">æœªç¼´è´¹ç”¨æ€»è®¡</h6>
                            <p class="card-text display-4">Â¥{{ unpaid_amount }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title">æœªç¼´è´¹ç”¨ç¬”æ•°</h6>
                            <p class="card-text display-4">{{ shop_unpaid_stats|length }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title">æ¬ è´¹åº—é“ºæ•°</h6>
                            <p class="card-text display-4">{{ shop_unpaid_stats|length }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if shop_unpaid_stats %}
            <h6 class="card-subtitle mb-2 text-muted">åº—é“ºæœªç¼´è´¹ç”¨æ˜ç»†</h6>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>åº—é“ºåç§°</th>
                            <th>æœªç¼´é‡‘é¢</th>
                            <th>æœªç¼´ç¬”æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in shop_unpaid_stats %}
                        <tr>
                            <td>{{ stat.contract__shop__name }}</td>
                            <td>Â¥{{ stat.total_amount }}</td>
                            <td>{{ stat.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">æš‚æ— æœªç¼´è´¹ç”¨</p>
            {% endif %}
        </div>
    </div>
    
    <!-- è´¹ç”¨ç±»å‹ç»Ÿè®¡ -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="card-title">è´¹ç”¨ç±»å‹ç»Ÿè®¡</h5>
        </div>
        <div class="card-body">
            {% if fee_type_stats %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>è´¹ç”¨ç±»å‹</th>
                            <th>æ€»é‡‘é¢</th>
                            <th>ç¬”æ•°</th>
                            <th>å¹³å‡é‡‘é¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in fee_type_stats %}
                        <tr>
                            <td>
                                {% if stat.fee_type == 'RENT' %}ç§Ÿé‡‘
                                {% elif stat.fee_type == 'PROPERTY_FEE' %}ç‰©ä¸šè´¹
                                {% elif stat.fee_type == 'UTILITY_FEE' %}æ°´ç”µè´¹
                                {% else %}å…¶ä»–è´¹ç”¨{% endif %}
                            </td>
                            <td>Â¥{{ stat.total_amount }}</td>
                            <td>{{ stat.count }}</td>
                            <td>Â¥{{ stat.total_amount|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">æš‚æ— è´¹ç”¨ç±»å‹ç»Ÿè®¡æ•°æ®</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ui-tokens.css' %}">
<link rel="stylesheet" href="{% static 'css/ui-components.css' %}">
<link rel="stylesheet" href="{% static 'css/query-detail.css' %}">
{% endblock %}

{% block content %}
<div class="query-detail">
    <div class="query-detail-header">
        <span class="query-detail-bar"></span>
        <div>
            <div class="query-detail-title">&#x8FD0;&#x8425;&#x67E5;&#x8BE2;</div>
            <div class="query-detail-subtitle">&#x5206;&#x7BA1;&#x533A;&#x57DF;&#x5E97;&#x94FA;&#x8FD0;&#x8425;&#x4FE1;&#x606F;&#x4E0E;&#x6570;&#x636E;&#x6C47;&#x603B;</div>
        </div>
    </div>

    <div class="ui-card ui-section query-detail-section">
        <div class="query-detail-header-row">
            <div class="ui-title">&#x67E5;&#x8BE2;&#x6761;&#x4EF6;</div>
            <span class="ui-text-muted">&#x53EF;&#x6309;&#x4E1A;&#x6001;&#x4E0E;&#x65F6;&#x95F4;&#x7EF4;&#x5EA6;&#x7B5B;&#x9009;</span>
        </div>
        <form method="get" action="{% url 'query:operation_query' %}">
            <div class="query-detail-grid">
                <div>
                    <label for="business_type" class="form-label">&#x4E1A;&#x6001;&#x7C7B;&#x578B;</label>
                    <select class="form-control ui-input" id="business_type" name="business_type">
                        <option value="">-- &#x5168;&#x90E8;&#x4E1A;&#x6001; --</option>
                        <option value="RETAIL" {% if is_retail %}selected{% endif %}>&#x96F6;&#x552E;</option>
                        <option value="FOOD" {% if is_food %}selected{% endif %}>&#x9910;&#x996E;</option>
                        <option value="ENTERTAINMENT" {% if is_entertainment %}selected{% endif %}>&#x5A31;&#x4E50;</option>
                        <option value="SERVICE" {% if is_service %}selected{% endif %}>&#x670D;&#x52A1;</option>
                        <option value="OTHER" {% if is_other %}selected{% endif %}>&#x5176;&#x4ED6;</option>
                    </select>
                </div>
                <div>
                    <label for="period" class="form-label">&#x65F6;&#x95F4;&#x8303;&#x56F4;</label>
                    <select class="form-control ui-input" id="period" name="period">
                        <option value="week" {% if is_week %}selected{% endif %}>&#x6700;&#x8FD1;7&#x5929;</option>
                        <option value="month" {% if is_month %}selected{% endif %}>&#x6700;&#x8FD1;30&#x5929;</option>
                        <option value="quarter" {% if is_quarter %}selected{% endif %}>&#x6700;&#x8FD1;90&#x5929;</option>
                        <option value="year" {% if is_year %}selected{% endif %}>&#x6700;&#x8FD1;1&#x5E74;</option>
                        <option value="custom" {% if is_custom %}selected{% endif %}>&#x81EA;&#x5B9A;&#x4E49;&#x8303;&#x56F4;</option>
                    </select>
                </div>
                <div class="query-detail-actions">
                    <button type="submit" class="ui-btn ui-btn-primary">&#x67E5;&#x8BE2;</button>
                </div>
            </div>

            <div id="custom_date_range" {% if not is_custom %}style="display: none;" {% endif %}>
                <div class="query-detail-grid mt-3">
                    <div>
                        <label for="start_date" class="form-label">&#x5F00;&#x59CB;&#x65E5;&#x671F;</label>
                        <input type="date" class="form-control ui-input" id="start_date" name="start_date"
                            value="{{ start_date|date:'Y-m-d' }}">
                    </div>
                    <div>
                        <label for="end_date" class="form-label">&#x7ED3;&#x675F;&#x65E5;&#x671F;</label>
                        <input type="date" class="form-control ui-input" id="end_date" name="end_date"
                            value="{{ end_date|date:'Y-m-d' }}">
                    </div>
                </div>
            </div>
            {% if date_input_error %}
            <div class="mt-2 text-danger" role="alert">{{ date_input_error }}</div>
            {% endif %}
        </form>
    </div>

    <div class="ui-card ui-section query-detail-section">
        <div class="query-detail-header-row">
            <div class="ui-title">&#x5206;&#x7BA1;&#x533A;&#x57DF;&#x5E97;&#x94FA;&#x4FE1;&#x606F;</div>
            <span class="ui-text-muted">&#x5E97;&#x94FA;&#x57FA;&#x7840;&#x4FE1;&#x606F;&#x5217;&#x8868;</span>
        </div>
        {% if shops %}
        <div class="table-responsive query-detail-table">
            <table class="ui-table">
                <thead>
                    <tr>
                        <th>&#x5E97;&#x94FA;ID</th>
                        <th>&#x5E97;&#x94FA;&#x540D;&#x79F0;</th>
                        <th>&#x4E1A;&#x6001;&#x7C7B;&#x578B;</th>
                        <th>&#x7ECF;&#x8425;&#x9762;&#x79EF;</th>
                        <th>&#x79DF;&#x91D1;</th>
                        <th>&#x8054;&#x7CFB;&#x4EBA;</th>
                        <th>&#x8054;&#x7CFB;&#x65B9;&#x5F0F;</th>
                        <th>&#x5165;&#x9A7B;&#x65E5;&#x671F;</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shop in shops %}
                    <tr>
                        <td>{{ shop.id }}</td>
                        <td>{{ shop.name }}</td>
                        <td>{{ shop.get_business_type_display }}</td>
                        <td>{{ shop.area }} &#x5E73;&#x65B9;&#x7C73;</td>
                        <td>&#xA5;{{ shop.rent }}/&#x6708;</td>
                        <td>{{ shop.contact_person }}</td>
                        <td>{{ shop.contact_phone }}</td>
                        <td>{{ shop.entry_date|date:"Y-m-d" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center ui-text-muted">&#x6682;&#x65E0;&#x5E97;&#x94FA;&#x4FE1;&#x606F;</p>
        {% endif %}
    </div>

    {% if manual_data_summary or device_data_summary %}
    <div class="ui-card ui-section query-detail-section">
        <div class="query-detail-header-row">
            <div class="ui-title">&#x8FD0;&#x8425;&#x6570;&#x636E;&#x6C47;&#x603B;</div>
            <span class="ui-text-muted">&#x624B;&#x52A8;&#x4E0E;&#x8BBE;&#x5907;&#x6570;&#x636E;&#x7EDF;&#x8BA1;</span>
        </div>
        <div class="row">
            {% if manual_data_summary %}
            <div class="col-md-6">
                <h6 class="ui-text-muted">&#x624B;&#x52A8;&#x4E0A;&#x4F20;&#x6570;&#x636E;&#x6C47;&#x603B;</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>&#x603B;&#x9500;&#x552E;&#x989D;&#xFF1A;</strong>&#xA5;{{ manual_data_summary.total_sales|default:"0" }}
                    </li>
                    <li class="list-group-item">
                        <strong>&#x603B;&#x5BA2;&#x6D41;&#x91CF;&#xFF1A;</strong>{{ manual_data_summary.total_foot_traffic|default:"0" }}
                    </li>
                    <li class="list-group-item">
                        <strong>&#x603B;&#x4EA4;&#x6613;&#x7B14;&#x6570;&#xFF1A;</strong>{{ manual_data_summary.total_transactions|default:"0" }}
                    </li>
                    <li class="list-group-item">
                        <strong>&#x5E73;&#x5747;&#x5BA2;&#x5355;&#x4EF7;&#xFF1A;</strong>&#xA5;{{ manual_data_summary.avg_transaction_value|default:"0" }}
                    </li>
                </ul>
            </div>
            {% endif %}

            {% if device_data_summary %}
            <div class="col-md-6">
                <h6 class="ui-text-muted">&#x8BBE;&#x5907;&#x91C7;&#x96C6;&#x6570;&#x636E;&#x6C47;&#x603B;</h6>
                <div class="table-responsive query-detail-table">
                    <table class="ui-table">
                        <thead>
                            <tr>
                                <th>&#x6570;&#x636E;&#x7C7B;&#x578B;</th>
                                <th>&#x603B;&#x6570;&#x503C;</th>
                                <th>&#x5E73;&#x5747;&#x503C;</th>
                                <th>&#x6570;&#x636E;&#x91CF;</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in device_data_summary %}
                            <tr>
                                <td>{{ data.data_type }}</td>
                                <td>{{ data.total_value }}</td>
                                <td>{{ data.avg_value }}</td>
                                <td>{{ data.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="row query-detail-section">
        <div class="col-md-6">
            <div class="ui-card ui-section query-detail-card">
                <div class="query-detail-header-row">
                    <div class="ui-title">&#x7EF4;&#x4FEE;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x60C5;&#x51B5;</div>
                    <span class="ui-text-muted">&#x8FDB;&#x5EA6;&#x5360;&#x6BD4;</span>
                </div>
                {% if maintenance_stats %}
                <div class="table-responsive query-detail-table">
                    <table class="ui-table">
                        <thead>
                            <tr>
                                <th>&#x72B6;&#x6001;</th>
                                <th>&#x6570;&#x91CF;</th>
                                <th>&#x5360;&#x6BD4;</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in maintenance_stats %}
                            <tr>
                                <td>
                                    {% if stat.status == 'PENDING' %}&#x5F85;&#x5904;&#x7406;
                                    {% elif stat.status == 'ASSIGNED' %}&#x5DF2;&#x6307;&#x6D3E;
                                    {% elif stat.status == 'IN_PROGRESS' %}&#x5904;&#x7406;&#x4E2D;
                                    {% elif stat.status == 'COMPLETED' %}&#x5DF2;&#x5B8C;&#x6210;
                                    {% else %}&#x5DF2;&#x53D6;&#x6D88;{% endif %}
                                </td>
                                <td>{{ stat.count }}</td>
                                <td>{{ stat.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center ui-text-muted">&#x6682;&#x65E0;&#x7EF4;&#x4FEE;&#x6570;&#x636E;</p>
                {% endif %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="ui-card ui-section query-detail-card">
                <div class="query-detail-header-row">
                    <div class="ui-title">&#x6D3B;&#x52A8;&#x7533;&#x8BF7;&#x5904;&#x7406;&#x60C5;&#x51B5;</div>
                    <span class="ui-text-muted">&#x5BA1;&#x6838;&#x7EDF;&#x8BA1;</span>
                </div>
                {% if activity_stats %}
                <div class="table-responsive query-detail-table">
                    <table class="ui-table">
                        <thead>
                            <tr>
                                <th>&#x72B6;&#x6001;</th>
                                <th>&#x6570;&#x91CF;</th>
                                <th>&#x5360;&#x6BD4;</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in activity_stats %}
                            <tr>
                                <td>
                                    {% if stat.status == 'PENDING' %}&#x5F85;&#x5BA1;&#x6838;
                                    {% elif stat.status == 'APPROVED' %}&#x5DF2;&#x6279;&#x51C6;
                                    {% elif stat.status == 'REJECTED' %}&#x5DF2;&#x62D2;&#x7EDD;
                                    {% else %}&#x5DF2;&#x53D6;&#x6D88;{% endif %}
                                </td>
                                <td>{{ stat.count }}</td>
                                <td>{{ stat.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center ui-text-muted">&#x6682;&#x65E0;&#x6D3B;&#x52A8;&#x7533;&#x8BF7;&#x6570;&#x636E;</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

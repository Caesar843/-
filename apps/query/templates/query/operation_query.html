{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">ğŸ“Š è¿è¥æŸ¥è¯¢</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">æŸ¥è¯¢æ¡ä»¶</h5>
            <form method="get" action="{% url 'query:operation_query' %}">
                <div class="form-row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="business_type">ä¸šæ€ç±»å‹</label>
                            <select class="form-control" id="business_type" name="business_type">
                                <option value="">-- å…¨éƒ¨ä¸šæ€ --</option>
                                <option value="RETAIL" {% if is_retail %}selected{% endif %}>é›¶å”®</option>
                                <option value="FOOD" {% if is_food %}selected{% endif %}>é¤é¥®</option>
                                <option value="ENTERTAINMENT" {% if is_entertainment %}selected{% endif %}>å¨±ä¹</option>
                                <option value="SERVICE" {% if is_service %}selected{% endif %}>æœåŠ¡</option>
                                <option value="OTHER" {% if is_other %}selected{% endif %}>å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="period">æ—¶é—´èŒƒå›´</label>
                            <select class="form-control" id="period" name="period">
                                <option value="week" {% if is_week %}selected{% endif %}>æœ€è¿‘7å¤©</option>
                                <option value="month" {% if is_month %}selected{% endif %}>æœ€è¿‘30å¤©</option>
                                <option value="quarter" {% if is_quarter %}selected{% endif %}>æœ€è¿‘90å¤©</option>
                                <option value="year" {% if is_year %}selected{% endif %}>æœ€è¿‘1å¹´</option>
                                <option value="custom" {% if is_custom %}selected{% endif %}>è‡ªå®šä¹‰èŒƒå›´</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-block">æŸ¥è¯¢</button>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ï¼Œä»…åœ¨é€‰æ‹©"è‡ªå®šä¹‰èŒƒå›´"æ—¶æ˜¾ç¤º -->
                <div id="custom_date_range" {% if not is_custom %}style="display: none;" {% endif %}>
                    <div class="form-row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="start_date">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="start_date" name="start_date"
                                    value="{{ start_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="end_date">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control" id="end_date" name="end_date"
                                    value="{{ end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ†ç®¡åŒºåŸŸåº—é“ºä¿¡æ¯ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title">åˆ†ç®¡åŒºåŸŸåº—é“ºä¿¡æ¯</h5>
        </div>
        <div class="card-body">
            {% if shops %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>åº—é“ºID</th>
                            <th>åº—é“ºåç§°</th>
                            <th>ä¸šæ€ç±»å‹</th>
                            <th>ç»è¥é¢ç§¯</th>
                            <th>ç§Ÿé‡‘</th>
                            <th>è”ç³»äºº</th>
                            <th>è”ç³»æ–¹å¼</th>
                            <th>å…¥é©»æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for shop in shops %}
                        <tr>
                            <td>{{ shop.id }}</td>
                            <td>{{ shop.name }}</td>
                            <td>{{ shop.get_business_type_display }}</td>
                            <td>{{ shop.area }} å¹³æ–¹ç±³</td>
                            <td>Â¥{{ shop.rent }}/æœˆ</td>
                            <td>{{ shop.contact_person }}</td>
                            <td>{{ shop.contact_phone }}</td>
                            <td>{{ shop.entry_date|date:"Y-m-d" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">æš‚æ— åº—é“ºä¿¡æ¯</p>
            {% endif %}
        </div>
    </div>

    <!-- è¿è¥æ•°æ®æ±‡æ€» -->
    {% if manual_data_summary or device_data_summary %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title">è¿è¥æ•°æ®æ±‡æ€»</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% if manual_data_summary %}
                <div class="col-md-6">
                    <h6 class="card-subtitle mb-2 text-muted">æ‰‹åŠ¨ä¸Šä¼ æ•°æ®æ±‡æ€»</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>æ€»é”€å”®é¢ï¼š</strong>Â¥{{ manual_data_summary.total_sales|default:"0" }}
                        </li>
                        <li class="list-group-item">
                            <strong>æ€»å®¢æµé‡ï¼š</strong>{{ manual_data_summary.total_foot_traffic|default:"0" }}
                        </li>
                        <li class="list-group-item">
                            <strong>æ€»äº¤æ˜“ç¬”æ•°ï¼š</strong>{{ manual_data_summary.total_transactions|default:"0" }}
                        </li>
                        <li class="list-group-item">
                            <strong>å¹³å‡å®¢å•ä»·ï¼š</strong>Â¥{{ manual_data_summary.avg_transaction_value|default:"0" }}
                        </li>
                    </ul>
                </div>
                {% endif %}

                {% if device_data_summary %}
                <div class="col-md-6">
                    <h6 class="card-subtitle mb-2 text-muted">è®¾å¤‡é‡‡é›†æ•°æ®æ±‡æ€»</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>æ•°æ®ç±»å‹</th>
                                    <th>æ€»æ•°å€¼</th>
                                    <th>å¹³å‡å€¼</th>
                                    <th>æ•°æ®é‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in device_data_summary %}
                                <tr>
                                    <td>{{ data.data_type }}</td>
                                    <td>{{ data.total_value }}</td>
                                    <td>{{ data.avg_value }}</td>
                                    <td>{{ data.count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- äº‹åŠ¡å¤„ç†æƒ…å†µ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title">ç»´ä¿®è¯·æ±‚å¤„ç†æƒ…å†µ</h5>
                </div>
                <div class="card-body">
                    {% if maintenance_stats %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>æ•°é‡</th>
                                    <th>å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in maintenance_stats %}
                                <tr>
                                    <td>
                                        {% if stat.status == 'PENDING' %}å¾…å¤„ç†
                                        {% elif stat.status == 'ASSIGNED' %}å·²æŒ‡æ´¾
                                        {% elif stat.status == 'IN_PROGRESS' %}å¤„ç†ä¸­
                                        {% elif stat.status == 'COMPLETED' %}å·²å®Œæˆ
                                        {% else %}å·²å–æ¶ˆ{% endif %}
                                    </td>
                                    <td>{{ stat.count }}</td>
                                    <td>
                                        {{ stat.percentage }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">æš‚æ— ç»´ä¿®è¯·æ±‚æ•°æ®</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title">æ´»åŠ¨ç”³è¯·å¤„ç†æƒ…å†µ</h5>
                </div>
                <div class="card-body">
                    {% if activity_stats %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>æ•°é‡</th>
                                    <th>å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in activity_stats %}
                                <tr>
                                    <td>
                                        {% if stat.status == 'PENDING' %}å¾…å®¡æ ¸
                                        {% elif stat.status == 'APPROVED' %}å·²æ‰¹å‡†
                                        {% elif stat.status == 'REJECTED' %}å·²æ‹’ç»
                                        {% else %}å·²å–æ¶ˆ{% endif %}
                                    </td>
                                    <td>{{ stat.count }}</td>
                                    <td>
                                        {{ stat.percentage }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">æš‚æ— æ´»åŠ¨ç”³è¯·æ•°æ®</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
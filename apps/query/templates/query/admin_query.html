{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">ğŸ“ˆ ç®¡ç†å±‚æŸ¥è¯¢</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">æŸ¥è¯¢æ¡ä»¶</h5>
            <form method="get" action="{% url 'query:admin_query' %}">
                <div class="form-row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="business_type">ä¸šæ€ç±»å‹</label>
                            <select class="form-control" id="business_type" name="business_type">
                                <option value="">-- å…¨éƒ¨ä¸šæ€ --</option>
                                <option value="RETAIL" {% if is_retail %}selected{% endif %}>é›¶å”®</option>
                                <option value="FOOD" {% if is_food %}selected{% endif %}>é¤é¥®</option>
                                <option value="ENTERTAINMENT" {% if is_entertainment %}selected{% endif %}>å¨±ä¹</option>
                                <option value="SERVICE" {% if is_service %}selected{% endif %}>æœåŠ¡</option>
                                <option value="OTHER" {% if is_other %}selected{% endif %}>å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="period">æ—¶é—´èŒƒå›´</label>
                            <select class="form-control" id="period" name="period">
                                <option value="week" {% if is_week %}selected{% endif %}>æœ€è¿‘7å¤©</option>
                                <option value="month" {% if is_month %}selected{% endif %}>æœ€è¿‘30å¤©</option>
                                <option value="quarter" {% if is_quarter %}selected{% endif %}>æœ€è¿‘90å¤©</option>
                                <option value="year" {% if is_year %}selected{% endif %}>æœ€è¿‘1å¹´</option>
                                <option value="custom" {% if is_custom %}selected{% endif %}>è‡ªå®šä¹‰èŒƒå›´</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-block">æŸ¥è¯¢</button>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ï¼Œä»…åœ¨é€‰æ‹©"è‡ªå®šä¹‰èŒƒå›´"æ—¶æ˜¾ç¤º -->
                <div id="custom_date_range" {% if not is_custom %}style="display: none;" {% endif %}>
                    <div class="form-row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="start_date">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="start_date" name="start_date"
                                    value="{{ start_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="end_date">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control" id="end_date" name="end_date"
                                    value="{{ end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- å•†åœºæ¦‚è§ˆ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title">å•†åœºæ¦‚è§ˆ</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æ€»åº—é“ºæ•°</h6>
                            <p class="card-text display-4">{{ overview.total_shops }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">å·²å…¥é©»åº—é“º</h6>
                            <p class="card-text display-4">{{ overview.active_shops }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">ç©ºé“ºæ•°é‡</h6>
                            <p class="card-text display-4">{{ overview.vacant_shops }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">å…¥é©»ç‡</h6>
                            <p class="card-text display-4">{{ overview.occupancy_rate }}%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è´¢åŠ¡æ¦‚è§ˆ -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="card-title">è´¢åŠ¡æ¦‚è§ˆ</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æ€»ç§Ÿé‡‘æ”¶å…¥</h6>
                            <p class="card-text display-4">Â¥{{ overview.total_rent_income }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æ€»ç‰©ä¸šè´¹æ”¶å…¥</h6>
                            <p class="card-text display-4">Â¥{{ overview.total_property_income }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æ€»æ°´ç”µè´¹æ”¶å…¥</h6>
                            <p class="card-text display-4">Â¥{{ overview.total_utility_income }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æ€»æ”¶å…¥</h6>
                            <p class="card-text display-4">Â¥{{ overview.total_income }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿è¥æ•°æ® -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title">è¿è¥æ•°æ®</h5>
        </div>
        <div class="card-body">
            {% if operation_data %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>å®¢æµé‡</th>
                            <th>é”€å”®é¢</th>
                            <th>äº¤æ˜“ç¬”æ•°</th>
                            <th>å®¢å•ä»·</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in operation_data %}
                        <tr>
                            <td>{{ data.data_date|date:"Y-m-d" }}</td>
                            <td>{{ data.foot_traffic }}</td>
                            <td>Â¥{{ data.sales_amount }}</td>
                            <td>{{ data.transaction_count }}</td>
                            <td>Â¥{{ data.average_transaction_value }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">æš‚æ— è¿è¥æ•°æ®</p>
            {% endif %}
        </div>
    </div>

    <!-- åº—é“ºè¿è¥æ’å -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="card-title">åº—é“ºè¿è¥æ’å</h5>
        </div>
        <div class="card-body">
            {% if shop_performance %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>åº—é“ºåç§°</th>
                            <th>ä¸šæ€ç±»å‹</th>
                            <th>é”€å”®é¢</th>
                            <th>å®¢æµé‡</th>
                            <th>å®¢å•ä»·</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for performance in shop_performance %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ performance.shop__name }}</td>
                            <td>{{ performance.shop__get_business_type_display }}</td>
                            <td>Â¥{{ performance.total_sales }}</td>
                            <td>{{ performance.total_foot_traffic }}</td>
                            <td>Â¥{{ performance.avg_transaction_value }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">æš‚æ— åº—é“ºè¿è¥æ•°æ®</p>
            {% endif %}
        </div>
    </div>

    <!-- äº‹åŠ¡å¤„ç†æƒ…å†µ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title">ç»´ä¿®è¯·æ±‚å¤„ç†æƒ…å†µ</h5>
                </div>
                <div class="card-body">
                    {% if maintenance_stats %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>æ•°é‡</th>
                                    <th>å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in maintenance_stats %}
                                <tr>
                                    <td>
                                        {% if stat.status == 'PENDING' %}å¾…å¤„ç†
                                        {% elif stat.status == 'ASSIGNED' %}å·²æŒ‡æ´¾
                                        {% elif stat.status == 'IN_PROGRESS' %}å¤„ç†ä¸­
                                        {% elif stat.status == 'COMPLETED' %}å·²å®Œæˆ
                                        {% else %}å·²å–æ¶ˆ{% endif %}
                                    </td>
                                    <td>{{ stat.count }}</td>
                                    <td>
                                        {{ stat.percentage }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">æš‚æ— ç»´ä¿®è¯·æ±‚æ•°æ®</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title">æ´»åŠ¨ç”³è¯·å¤„ç†æƒ…å†µ</h5>
                </div>
                <div class="card-body">
                    {% if activity_stats %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>æ•°é‡</th>
                                    <th>å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in activity_stats %}
                                <tr>
                                    <td>
                                        {% if stat.status == 'PENDING' %}å¾…å®¡æ ¸
                                        {% elif stat.status == 'APPROVED' %}å·²æ‰¹å‡†
                                        {% elif stat.status == 'REJECTED' %}å·²æ‹’ç»
                                        {% else %}å·²å–æ¶ˆ{% endif %}
                                    </td>
                                    <td>{{ stat.count }}</td>
                                    <td>
                                        {{ stat.percentage }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">æš‚æ— æ´»åŠ¨ç”³è¯·æ•°æ®</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
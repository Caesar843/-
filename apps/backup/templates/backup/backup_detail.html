{% extends 'base.html' %}
{% load backup_filters %}

{% block title %}备份详情 - {{ backup.backup_name }}{% endblock %}


{% block extra_css %}
{% include 'partials/modern_theme.html' %}
{% endblock %}



{% block content %}
<div class="container-fluid mt-4 page-shell">
    <!-- 页面头部 -->
    <div class="row mb-4 page-header">
        <div class="col-md-8">
            <h1 class="page-title"><i class="fas fa-box"></i> {{ backup.backup_name }}</h1>
            <p class="text-muted page-subtitle">备份ID: {{ backup.id }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'backup:backup_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 返回列表
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 主要信息 -->
        <div class="col-lg-8">
            <!-- 基本信息卡片 -->
            <div class="card mb-4 section-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">基本信息</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">备份类型</p>
                            {% if backup.backup_type == 'FULL' %}
                            <span class="badge bg-info" style="font-size: 14px; padding: 6px 12px;">全量备份</span>
                            {% else %}
                            <span class="badge bg-secondary" style="font-size: 14px; padding: 6px 12px;">增量备份</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">备份状态</p>
                            {% if backup.status == 'SUCCESS' %}
                            <span class="badge bg-success" style="font-size: 14px; padding: 6px 12px;">✓ 成功</span>
                            {% elif backup.status == 'FAILED' %}
                            <span class="badge bg-danger" style="font-size: 14px; padding: 6px 12px;">✗ 失败</span>
                            {% elif backup.status == 'RUNNING' %}
                            <span class="badge bg-warning" style="font-size: 14px; padding: 6px 12px;">⟳ 进行中</span>
                            {% else %}
                            <span class="badge bg-secondary" style="font-size: 14px; padding: 6px 12px;">◯ 待处理</span>
                            {% endif %}
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">创建时间</p>
                            <p>{{ backup.created_at|date:"Y-m-d H:i:s" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">备份方式</p>
                            <p>
                                {% if backup.is_automatic %}
                                <i class="fas fa-robot text-info"></i> 自动备份
                                {% else %}
                                <i class="fas fa-user text-primary"></i> 手动备份
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    {% if backup.created_by %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">创建者</p>
                            <p>{{ backup.created_by.username }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">创建邮箱</p>
                            <p>{{ backup.created_by.email }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if backup.description %}
                    <div class="row">
                        <div class="col-12 mb-3">
                            <p class="text-muted mb-1">备份说明</p>
                            <p>{{ backup.description }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 文件信息卡片 -->
            <div class="card mb-4 section-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">文件信息</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">文件大小</p>
                            <p style="font-size: 18px; font-weight: bold; color: #2E86AB;">
                                {% with size=backup.file_size %}
                                {% if size < 1048576 %}{{ size|filesizeformat }}{% elif size < 1073741824 %}{{
                                    size|div:1048576|floatformat:2 }} MB{% else %}{{ size|div:1073741824|floatformat:2
                                    }} GB{% endif %} {% endwith %} </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">备份耗时</p>
                            <p style="font-size: 18px; font-weight: bold; color: #06A77D;">
                                {% if backup.backup_start_time and backup.backup_end_time %}
                                {{ backup.backup_end_time|add:backup.backup_start_time|timesince }} 秒
                                {% else %}
                                -
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <p class="text-muted mb-1">文件路径</p>
                            <code style="word-break: break-all;">{{ backup.file_path }}</code>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <p class="text-muted mb-1">文件哈希值 (SHA256)</p>
                            <code style="word-break: break-all; font-size: 12px;">{{ backup.file_hash }}</code>
                        </div>
                    </div>

                    {% if backup.is_encrypted %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">加密状态</p>
                            <p><i class="fas fa-lock text-success"></i> 已加密</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1">加密密钥ID</p>
                            <p>{{ backup.encryption_key_id }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 数据内容卡片 -->
            <div class="card mb-4 section-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">备份数据内容</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for dtype in backup.data_types %}
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success"
                                    style="font-size: 20px; margin-right: 10px;"></i>
                                <span>
                                    {% if dtype == 'SHOP' %}
                                    店铺信息
                                    {% elif dtype == 'CONTRACT' %}
                                    合约数据
                                    {% elif dtype == 'OPERATION' %}
                                    运营数据
                                    {% elif dtype == 'FINANCE' %}
                                    财务记录
                                    {% elif dtype == 'LOG' %}
                                    事务日志
                                    {% else %}
                                    {{ dtype }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 错误信息 -->
            {% if backup.status == 'FAILED' and backup.error_message %}
            <div class="card border-danger mb-4 section-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">错误信息</h5>
                </div>
                <div class="card-body">
                    <pre
                        style="background-color: #f8f9fa; padding: 15px; border-radius: 4px;">{{ backup.error_message }}</pre>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 右侧操作面板 -->
        <div class="col-lg-4">
            <!-- 操作按钮 -->
            <div class="card mb-4 border-primary section-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">操作</h5>
                </div>
                <div class="card-body">
                    {% if backup.status == 'SUCCESS' %}
                    <a href="{% url 'backup:backup_download' backup.pk %}" class="btn btn-success w-100 mb-2">
                        <i class="fas fa-download"></i> 下载备份文件
                    </a>
                    <a href="{% url 'backup:backup_restore' backup.pk %}" class="btn btn-info w-100 mb-2">
                        <i class="fas fa-redo"></i> 恢复数据
                    </a>
                    <form method="post" action="{% url 'backup:backup_verify' backup.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning w-100 mb-2" onclick="return confirm('确认验证备份文件？');">
                            <i class="fas fa-check"></i> 验证备份
                        </button>
                    </form>
                    <form method="post" action="{% url 'backup:backup_delete' backup.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-100"
                            onclick="return confirm('确认删除该备份？此操作不可撤销！');">
                            <i class="fas fa-trash"></i> 删除备份
                        </button>
                    </form>
                    {% elif backup.status == 'FAILED' %}
                    <p class="text-danger mb-3">
                        <i class="fas fa-exclamation-triangle"></i> 备份失败，无法进行恢复操作
                    </p>
                    <form method="post" action="{% url 'backup:backup_delete' backup.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-100" onclick="return confirm('确认删除该备份？');">
                            <i class="fas fa-trash"></i> 删除备份
                        </button>
                    </form>
                    {% elif backup.status == 'RUNNING' %}
                    <div class="alert alert-warning">
                        <i class="fas fa-spinner fa-spin"></i> 备份正在进行中，请稍候...
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <i class="fas fa-clock"></i> 备份待处理，请稍候...
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 恢复统计 -->
            {% if backup.recovery_records > 0 %}
            <div class="card mb-4 section-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">恢复统计</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">使用次数</p>
                    <p style="font-size: 24px; color: #A23B72; font-weight: bold; margin-bottom: 10px;">
                        {{ backup.recovery_records }}
                    </p>
                    {% if backup.last_recovered_at %}
                    <p class="text-muted mb-2">最后恢复时间</p>
                    <p>{{ backup.last_recovered_at|date:"Y-m-d H:i:s" }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 操作日志 -->
    <div class="card mt-4 section-card">
        <div class="card-header bg-light">
            <h5 class="mb-0">操作日志</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th>操作类型</th>
                        <th>日志级别</th>
                        <th>消息</th>
                        <th>操作者</th>
                        <th>时间</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            {% if log.operation == 'BACKUP' %}
                            <span class="badge bg-primary">备份</span>
                            {% elif log.operation == 'RESTORE' %}
                            <span class="badge bg-success">恢复</span>
                            {% elif log.operation == 'VERIFY' %}
                            <span class="badge bg-warning">验证</span>
                            {% elif log.operation == 'DELETE' %}
                            <span class="badge bg-danger">删除</span>
                            {% elif log.operation == 'DOWNLOAD' %}
                            <span class="badge bg-info">下载</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.log_level == 'SUCCESS' %}
                            <span class="badge bg-success">成功</span>
                            {% elif log.log_level == 'ERROR' %}
                            <span class="badge bg-danger">错误</span>
                            {% elif log.log_level == 'WARNING' %}
                            <span class="badge bg-warning">警告</span>
                            {% else %}
                            <span class="badge bg-info">信息</span>
                            {% endif %}
                        </td>
                        <td>{{ log.message }}</td>
                        <td>
                            {% if log.operated_by %}
                            {{ log.operated_by.username }}
                            {% else %}
                            系统
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ log.created_at|date:"Y-m-d H:i" }}</small>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">暂无日志</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .card {
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .card-header {
        border-bottom: 1px solid #ddd;
    }

    code {
        background-color: #f5f5f5;
        padding: 4px 8px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }
</style>
{% endblock %}
